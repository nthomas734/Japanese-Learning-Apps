<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Japanese Flash Cards — v1.11.0</title>

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121622;
      --panel2:#0f131d;
      --border:#22283a;
      --text:#e9ecf5;
      --muted:#aeb6cf;
      --muted2:#7f8aa9;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --bad:#ff5d6c;
      --warn:#ffcc66;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --pad:14px;
      --pad2:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{ min-height:100%; height:auto; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(122,162,255,.28), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(61,220,151,.18), transparent 60%),
                  radial-gradient(900px 700px at 10% 60%, rgba(255,93,108,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    header{
      max-width:1200px;
      margin:0 auto;
      padding:18px 14px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    .title h1{ margin:0; font-size:22px; letter-spacing:.2px; font-weight:720; }
    
    /* UPDATED: Subtitle Link Styling */
    .title .sub a { color:var(--muted); text-decoration:none; font-size:13px; border-bottom:1px dotted var(--muted); transition: color 0.2s; }
    .title .sub a:hover { color:var(--accent); border-bottom-color:var(--accent); }
    
    .badgeTop{
      display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:8px 12px; border-radius:999px; box-shadow:0 10px 24px rgba(0,0,0,.25);
      white-space:nowrap; font-size:13px; color:var(--muted); height:fit-content;
    }
    .badgeTop .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.15)), var(--accent);
      box-shadow:0 0 0 4px rgba(122,162,255,.14);
    }
    .mono{font-family:var(--mono)}

    main{
      max-width:1200px; margin:0 auto; padding:14px 14px 28px;
      display:grid; grid-template-columns: 360px 1fr; gap:14px;
    }

    .right-col {
      display: flex;
      flex-direction: column;
      gap: 14px;
      height: 100%;
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius2);
      box-shadow:var(--shadow); overflow:hidden;
    }

    .panel h2{
      margin:0; font-size:14px; letter-spacing:.2px; color:var(--text); font-weight:700;
      padding:14px 14px 12px; border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-radius: var(--radius2) var(--radius2) 0 0;
    }
    .panel .bd{ padding:14px; }
    
    .section-label {
      font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted2);
      margin: 16px 0 8px; font-weight: 700;
    }
    .section-label:first-of-type { margin-top: 0; }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .row + .row{margin-top:10px}

    .pill{
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius:999px; border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.18);
    }
    .pill input{accent-color:var(--accent)}
    .pill label{font-size:13px; color:var(--muted); user-select:none}

    button{
      appearance:none; border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.10));
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:700; font-size:13px; letter-spacing:.15px; box-shadow:0 10px 22px rgba(0,0,0,.28);
      transition:transform .08s ease, filter .12s ease, opacity .12s ease;
    }
    button:hover{filter:brightness(1.04)}
    button:active{transform:translateY(1px)}
    button.primary{ background:linear-gradient(180deg, rgba(122,162,255,.35), rgba(122,162,255,.14)); }
    button.good{ background:linear-gradient(180deg, rgba(61,220,151,.22), rgba(61,220,151,.10)); }
    button.bad{ background:linear-gradient(180deg, rgba(255,93,108,.22), rgba(255,93,108,.10)); }
    button.warn{ background:linear-gradient(180deg, rgba(255,204,102,.24), rgba(255,204,102,.10)); color:#ffe7b0; }
    button.ghost{ background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.10); color:var(--muted); font-weight:650; box-shadow:none; }
    button:disabled{ opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }

    select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background: rgb(21, 22, 27);
      color: var(--text); font-size: 13px; outline: none; cursor: pointer;
    }
    .small{font-size:12px; color:var(--muted2)}
    .muted{color:var(--muted); font-size:13px; line-height:1.35}

    .flashcard {
      position:relative; min-height:300px; border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 420px at 50% -30%, rgba(122,162,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:0 18px 48px rgba(0,0,0,.42);
      padding:18px 18px 16px; overflow:hidden;
      display:flex; flex-direction:column; justify-content:space-between;
      user-select:none; cursor:pointer;
      padding-bottom:86px; 
    }

    .btn-audio-card {
      position: absolute; top: 58px; right: 12px; z-index: 10;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      border-radius: 50%; width: 38px; height: 38px; padding: 0;
      display: flex; align-items: center; justify-content: center; color: var(--accent);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.2s;
    }
    .btn-audio-card svg { width: 20px; height: 20px; fill: currentColor; }
    .btn-audio-card:hover { background: rgba(255,255,255,0.12); transform: scale(1.05); }

    .badge {
      position:absolute; top: 12px; left: 12px; font-size: 12px; color: var(--muted);
      border:1px solid var(--border); background: rgba(0,0,0,.18);
      padding: 6px 10px; border-radius: 999px; z-index: 2;
      max-width: calc(50% - 18px); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .badge.right{ left:auto; right:12px; }

    .hidden{ display:none !important; }

    .content{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; padding:26px 6px 10px; text-align:center; flex:1;
    }

    .big{ font-size:44px; font-weight:800; letter-spacing:.6px; line-height:1.08; transition: font-size 0.2s; }
    .super-big { font-size: 120px; font-weight: 800; line-height: 1.1; margin-bottom: 10px; }

    .mid_jp{ font-size:22px; font-weight:750; letter-spacing:.2px; line-height:1.1; color:var(--text); }
    .mid_txt{ font-size:18px; color:var(--muted); font-weight:650; }
    .smallLine{ font-size:14px; color:var(--muted2); }
    
    .kana-sub { font-size:32px; font-weight:700; color:var(--text); opacity:1; margin-top:8px; }

    .controls{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .controls .row{justify-content:center}
    
    .stats{ text-align:center; color:var(--muted); font-size:15px; font-weight:600; margin-top:6px; letter-spacing: 0.3px; }

    .cardActions{
      position:absolute; left:14px; right:14px; bottom:14px;
      display:flex; gap:12px; align-items:center; justify-content: center;
    }
    .cardActions button{ flex:1; min-width:0; }
    .cardActions button#btn_unsure{ flex:1.1; }

    .toast {
      margin-top: 12px; text-align: center; color: var(--text); font-size: 15px; font-weight: 700;
      min-height: 24px; opacity: 0; transition: opacity 0.2s;
    }
    .toast.visible { opacity: 1; }
    .toast.good { color: var(--good); text-shadow: 0 0 10px rgba(61,220,151,0.2); }
    .toast.bad { color: var(--bad); text-shadow: 0 0 10px rgba(255,93,108,0.2); }
    .toast.warn { color: var(--warn); }

    /* SEPARATE PROGRESS PANEL STYLES */
    #progress-section {
      flex: 1; 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      min-height: 140px; padding: 20px 24px;
      gap: 12px;
    }

    .progress-text {
      font-size: 14px; font-weight: 600; color: var(--muted); letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .progress-track {
      width: 100%;
      height: 32px;
      background: rgba(0,0,0,0.3);
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .progress-segment { height: 100%; transition: width 0.3s ease; }
    .seg-green { background: var(--good); box-shadow: 0 0 10px rgba(61,220,151,0.3); }
    .seg-red { background: var(--bad); box-shadow: 0 0 10px rgba(255,93,108,0.3); }
    
    .streak-container {
      display: flex; align-items: center; gap: 8px; justify-content: center;
      height: 32px; font-weight: 700; font-size: 15px; color: var(--text);
    }
    .streak-icon { font-size: 24px; }

    @media (max-width: 720px) {
      main{ grid-template-columns: 1fr; height: auto; }
      body.studying #sidebar { display: none; }
      body.studying .flashcard { margin-bottom: 20px; }
      body.studying .settingsToggle { display: inline-flex; }
      body.studying.showSettings #sidebar { display: block; position: fixed; inset: 0; z-index: 1000; overflow: auto; padding-bottom: 24px; background:var(--bg); }
      body.studying.showSettings #workspace { filter: blur(2px); }
      body.studying.showSettings .closeSettings { display: inline-flex; }
      .right-col { height: auto; }
      #progress-section { min-height: auto; padding: 24px; margin-bottom: 30px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Japanese Flash Cards</h1>
      <div class="sub"><a href="https://github.com/nthomas734/Japanese-Learning-Apps/tree/main" target="_blank">GitHub Repository</a></div>
    </div>
    <div class="badgeTop" title="Local, single-file app"><span class="dot"></span><span class="mono">offline-ready</span></div>
  </header>

  <main>
    <section class="panel" id="sidebar">
      <h2>Study Sets <button id="btn_closeSettings" class="ghost closeSettings hidden" type="button">Close</button></h2>
      <div class="bd">
        <div class="section-label">Vocabulary</div>
        <div class="row">
          <div class="pill"><input id="sel_all_vocab" type="checkbox" /><label for="sel_all_vocab">Select All</label></div>
        </div>
        <div class="row">
          <div class="pill"><input id="sel_essentials" type="checkbox" checked /><label for="sel_essentials">Essentials</label></div>
          <div class="pill"><input id="sel_travel" type="checkbox" checked /><label for="sel_travel">Travel</label></div>
          <div class="pill"><input id="sel_basic" type="checkbox" /><label for="sel_basic">Beginner</label></div>
        </div>

        <div class="section-label">Japanese Scripts</div>
        <div class="row">
          <div class="pill"><input id="sel_all_scripts" type="checkbox" /><label for="sel_all_scripts">Select All</label></div>
        </div>
        <div class="row">
          <div class="pill"><input id="sel_hira" type="checkbox" /><label for="sel_hira">Hiragana</label></div>
          <div class="pill"><input id="sel_kata" type="checkbox" /><label for="sel_kata">Katakana</label></div>
          <div class="pill"><input id="sel_kanji" type="checkbox" /><label for="sel_kanji">Kanji</label></div>
        </div>

        <div class="row" style="margin-top:14px;">
          <div style="flex:1; min-width:220px;">
            <div class="small" style="margin:0 0 6px 2px;">Build by Category (optional override)</div>
            <select id="by_category"><option value="">(No override)</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button id="btn_build" class="primary" type="button">Build Deck</button>
          <button id="btn_reset" class="ghost" type="button">Reset</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="muted">Select one or more sets, then click <b>Build Deck</b>.</div>
        </div>
        
        <div class="row" style="margin-top:14px; gap: 14px;">
          <div class="pill"><input id="opt_shuffle" type="checkbox" checked /><label for="opt_shuffle">Shuffle</label></div>
          <div class="pill"><input id="opt_incorrectOnly" type="checkbox" /><label for="opt_incorrectOnly">Incorrect-only view</label></div>
        </div>

        <div class="row" style="margin-top:12px; align-items:flex-start;">
           <div style="flex:1;">
            <div class="small" style="margin:0 0 6px 2px;">Starting Side</div>
            <select id="opt_side_mode">
                <option value="random">Random</option>
                <option value="jp">Japanese</option>
                <option value="en">English</option>
            </select>
          </div>
          <div style="flex:1;">
            <div class="small" style="margin:0 0 6px 2px;">Card Limit</div>
            <select id="opt_limit_select">
                <option value="0">All</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="btn_clearMisses" class="ghost" type="button">Clear incorrect list</button>
          <div class="small mono" id="missCount">Incorrect: 0</div>
        </div>
      </div>
    </section>

    <div class="right-col">
        <section class="panel" id="workspace">
          <h2>Study <span class="small mono">v1.11.0</span></h2>
          <div class="bd">
            <div class="flashcard" id="card" tabindex="0" title="Click to flip">
              <button id="btn_speak" class="btn-audio-card hidden" type="button" title="Play Audio">
                <svg viewBox="0 0 24 24"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.03C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"></path></svg>
              </button>

              <div class="badge" id="badge_left">—</div>
              <div class="badge right" id="badge_right">—</div>
              <div class="content">
                <div class="big" id="big">Build a deck to start</div>
                <div class="mid_jp hidden" id="mid_jp"></div>
                <div class="mid_txt" id="mid_txt"></div>
                <div class="smallLine" id="small"></div>
                <div class="cardActions" id="card_actions" aria-label="Answer actions">
                  <button class="good" id="btn_correct" type="button">Correct</button>
                  <button class="warn" id="btn_unsure" type="button">Unsure</button>
                  <button class="bad" id="btn_incorrect" type="button">Incorrect</button>
                </div>
              </div>
            </div>

            <div class="controls" id="controls_area">
              <div class="row">
                <button id="btn_prev">← Prev</button>
                <button id="btn_hint" class="ghost" type="button">Hint</button>
                <button class="primary" id="btn_flip">Flip</button>
                <button id="btn_next">Next →</button>
              </div>
              <div class="stats" id="stats">Deck not built yet.</div>
              <button id="btn_settings" class="ghost settingsToggle hidden" type="button">Settings</button>
            </div>
            
            <div class="toast" id="toast"></div>
          </div>
        </section>

        <section class="panel" id="progress-section">
            <div class="progress-text" id="progress_text">0 / 0 Correct</div>
            <div class="progress-track" id="progress_track"></div>
            <div class="streak-container" id="streak_container"></div>
        </section>
    </div>
  </main>

<script>
/* ========= Japanese Flash Cards — v1.11.0 ========= */
const APP = { version: "1.11.0", build: 44 };

const SETS = {
  ESSENTIALS: "Essentials",
  TRAVEL: "Travel",
  BASIC: "Beginner",
  HIRAGANA: "Hiragana",
  KATAKANA: "Katakana",
  KANJI: "Kanji"
};

/* --- EMBEDDED DATA START --- */
const VOCAB = {
  [SETS.ESSENTIALS]: {
    "Essentials": [
      { english: "Excuse me / Sorry", japanese: "すみません", romaji: "Sumimasen", pronunciation: "soo-mee-mah-sen" },
      { english: "Thank you very much", japanese: "ありがとうございます", romaji: "Arigatō gozaimasu", pronunciation: "ah-ree-gah-toh goh-zah-ee-mas" },
      { english: "This", japanese: "これ", romaji: "Kore", pronunciation: "koh-reh" },
      { english: "That (near you)", japanese: "それ", romaji: "Sore", pronunciation: "soh-reh" },
      { english: "Please (requesting an item)", japanese: "ください", romaji: "Kudasai", pronunciation: "koo-dah-sigh" },
      { english: "Please (general favor)", japanese: "お願いします", romaji: "Onegaishimasu", pronunciation: "oh-neh-guy-shee-mas" },
      { english: "No thank you / I'm good", japanese: "大丈夫です", romaji: "Daijōbu desu", pronunciation: "dye-joh-bu dess" },
      { english: "I am ~", japanese: "私は〜です", romaji: "Watashi wa ~ desu", pronunciation: "wah-tah-shee wah ~ dess" },
      { english: "I don’t understand", japanese: "わかりません", romaji: "Wakarimasen", pronunciation: "wah-kah-ree-mah-sen" }
    ],
    "Greetings": [
      { english: "Hello / Good afternoon", japanese: "こんにちは", romaji: "Konnichiwa", pronunciation: "kon-nee-chee-wah" },
      { english: "Good morning", japanese: "おはようございます", romaji: "Ohayō gozaimasu", pronunciation: "oh-hah-yoh goh-zah-ee-mas" },
      { english: "Good evening", japanese: "こんばんは", romaji: "Konbanwa", pronunciation: "kon-bahn-wah" },
      { english: "Good night", japanese: "おやすみ", romaji: "Oyasumi", pronunciation: "oh-yah-soo-mee" }
    ],
    "Restaurants": [
      { english: "Can I place an order?", japanese: "注文お願いします", romaji: "Chūmon onegaishimasu", pronunciation: "choo-mohn oh-neh-guy-shee-mas" },
      { english: "Water please", japanese: "水をお願いします", romaji: "Mizu o onegaishimasu", pronunciation: "mee-zoo oh oh-neh-guy-shee-mas" },
      { english: "Can I get the check / bill please", japanese: "お会計お願いします", romaji: "Okaikei onegaishimasu", pronunciation: "oh-kai-kay oh-neh-guy-shee-mas" }
    ]
  },
  [SETS.TRAVEL]: {
    "Restaurants": [
      { english: "Beer, one more", japanese: "ビールもう一杯", romaji: "Bīru mō ippai", pronunciation: "bee-roo moh ee-pie" },
      { english: "Reservation", japanese: "よやく", romaji: "Yoyaku", pronunciation: "yoh-yah-koo" }
    ],
    "Shopping": [
      { english: "Do you have (it)?", japanese: "ありますか", romaji: "Arimasu ka", pronunciation: "ah-ree-mas kah" },
      { english: "How much?", japanese: "いくら", romaji: "Ikura", pronunciation: "ee-koo-rah" },
      { english: "Please show me", japanese: "見せてください", romaji: "Misete kudasai", pronunciation: "mee-seh-teh koo-dah-sigh" }
    ],
    "Questions": [
      { english: "What is this?", japanese: "これは何ですか", romaji: "Kore wa nan desu ka", pronunciation: "koh-reh wah nahn dess kah" },
      { english: "What is your name?", japanese: "名前はなんですか", romaji: "Namae wa nan desu ka", pronunciation: "nah-mah-eh wah nahn dess kah" }
    ],
    "Directions": [
      { english: "Where is the bathroom?", japanese: "トイレはどこですか", romaji: "Toire wa doko desu ka", pronunciation: "toy-reh wah doh-koh dess kah" }
    ],
    "Communication": [
      { english: "I can’t speak Japanese", japanese: "日本語を話せません", romaji: "Nihongo o hanasemasen", pronunciation: "nee-hohn-goh oh hah-nah-seh-mah-sen" },
      { english: "I am practicing my Japanese", japanese: "私は日本語を練習しています。", romaji: "Watashi wa nihongo o renshū shite imasu", pronunciation: "wah-tah-shee wah nee-hohn-goh oh ren-shoo sheh-teh ee-mas" }
    ],
    "Hotel": [
      { english: "Reservation / appointment", japanese: "よやく", romaji: "Yoyaku", pronunciation: "yoh-yah-koo" }
    ],
    "Numbers": [
      { english: "Hundred", japanese: "ひゃく", romaji: "Hyaku", pronunciation: "hyah-koo" },
      { english: "Two hundred", japanese: "にひゃく", romaji: "Ni-hyaku", pronunciation: "nee-hyah-koo" },
      { english: "Three hundred", japanese: "さんびゃく", romaji: "San-byaku", pronunciation: "sahn-byah-koo" },
      { english: "Four hundred", japanese: "よんひゃく", romaji: "Yon-hyaku", pronunciation: "yohn-hyah-koo" },
      { english: "Six hundred", japanese: "ろっぴゃく", romaji: "Roppyaku", pronunciation: "roh-ppyah-koo" },
      { english: "Eight hundred", japanese: "はっぴゃく", romaji: "Happyaku", pronunciation: "hah-ppyah-koo" },
      { english: "Twenty", japanese: "にじゅう", romaji: "Ni-jū", pronunciation: "nee-joo" },
      { english: "Thirty", japanese: "さんじゅう", romaji: "San-jū", pronunciation: "sahn-joo" },
      { english: "Four thousand", japanese: "よんせん", romaji: "Yon-sen", pronunciation: "yohn-sen" },
      { english: "Three thousand", japanese: "さんぜん", romaji: "Sanzen", pronunciation: "sahn-zen" },
      { english: "Eight thousand", japanese: "はっせん", romaji: "Hassen", pronunciation: "hah-sen" }
    ],
    "Time & Dates": [
      { english: "From", japanese: "から", romaji: "Kara", pronunciation: "kah-rah" },
      { english: "Until / to", japanese: "まで", romaji: "Made", pronunciation: "mah-deh" },
      { english: "Morning / a.m.", japanese: "ごぜん", romaji: "Gozen", pronunciation: "goh-zen" },
      { english: "Afternoon / p.m.", japanese: "ごご", romaji: "Gogo", pronunciation: "goh-goh" }
    ]
  },
  [SETS.BASIC]: {
    "Key Phrases": [
      { english: "Yes", japanese: "はい", romaji: "Hai", pronunciation: "hai" },
      { english: "No", japanese: "いいえ", romaji: "Iie", pronunciation: "ee-eh" },
      { english: "What is your name?", japanese: "名前はなんですか", romaji: "Namae wa nan desu ka", pronunciation: "nah-mah-eh wah nahn dess kah" },
      { english: "I am ~", japanese: "私は〜です", romaji: "Watashi wa ~ desu", pronunciation: "wah-tah-shee wah dess" },
      { english: "I came from ~ / I am from ~", japanese: "〜から来ました", romaji: "~ kara kimashita", pronunciation: "kah-rah kee-mah-shee-tah" },
      { english: "What is this?", japanese: "これは何ですか", romaji: "Kore wa nan desu ka", pronunciation: "koh-reh wah nahn dess kah" },
      { english: "How much?", japanese: "いくらですか", romaji: "Ikura desu ka", pronunciation: "ee-koo-rah dess kah" },
      { english: "Can I get this one? / I'll take this one", japanese: "これください", romaji: "Kore kudasai", pronunciation: "koh-reh koo-dah-sigh" },
      { english: "Please", japanese: "おねがいします", romaji: "Onegaishimasu", pronunciation: "oh-neh-guy-shee-mas" },
      { english: "Can I place an order?", japanese: "注文お願いします", romaji: "Chūmon onegaishimasu", pronunciation: "choo-mohn oh-neh-guy-shee-mas" },
      { english: "Water please", japanese: "水をお願いします", romaji: "Mizu o onegaishimasu", pronunciation: "mee-zoo oh oh-neh-guy-shee-mas" },
      { english: "Can I get the check/bill?", japanese: "お会計お願いします", romaji: "Okaikei onegaishimasu", pronunciation: "oh-kai-kay oh-neh-guy-shee-mas" },
      { english: "Where am I?", japanese: "ここはどこですか", romaji: "Koko wa doko desu ka", pronunciation: "koh-koh wah doh-koh dess kah" },
      { english: "Where is the bathroom?", japanese: "トイレはどこですか", romaji: "Toire wa doko desu ka", pronunciation: "toy-reh wah doh-koh dess kah" },
      { english: "Where is the train station?", japanese: "駅はどこですか", romaji: "Eki wa doko desu ka", pronunciation: "eh-kee wah doh-koh dess kah" },
      { english: "What time is it now?", japanese: "今何時ですか", romaji: "Ima nan ji desu ka", pronunciation: "ee-mah nahn jee dess kah" },
      { english: "I don't understand", japanese: "わかりません", romaji: "Wakarimasen", pronunciation: "wah-kah-ree-mah-sen" },
      { english: "I can't speak Japanese", japanese: "日本語を話せません", romaji: "Nihongo o hanasemasen", pronunciation: "nee-hohn-goh oh hah-nah-seh-mah-sen" }
    ],
    "Greetings": [
      { english: "Good morning", japanese: "おはようございます", romaji: "Ohayō gozaimasu", pronunciation: "oh-hah-yoh goh-zah-ee-mas" },
      { english: "Good afternoon", japanese: "こんにちは", romaji: "Konnichiwa", pronunciation: "kon-nee-chee-wah" },
      { english: "Good evening", japanese: "こんばんは", romaji: "Konbanwa", pronunciation: "kon-bahn-wah" },
      { english: "Thank you", japanese: "ありがとうございます", romaji: "Arigatō gozaimasu", pronunciation: "ah-ree-gah-toh goh-zah-ee-mas" },
      { english: "Excuse me / I'm sorry", japanese: "すみません", romaji: "Sumimasen", pronunciation: "soo-mee-mah-sen" }
    ],
    "People & Pronouns": [
      { english: "I (watashi / boku / ore)", japanese: "私、僕、俺", romaji: "Watashi / Boku / Ore", pronunciation: "" },
      { english: "Friend", japanese: "友達", romaji: "Tomodachi", pronunciation: "toh-moh-dah-chee" },
      { english: "Co-worker", japanese: "同僚", romaji: "Dōryō", pronunciation: "doh-ryoh" },
      { english: "Boss / Company president", japanese: "部長、社長", romaji: "Buchō / Shachō", pronunciation: "boo-choh / shah-choh" },
      { english: "Family", japanese: "家族", romaji: "Kazoku", pronunciation: "kah-zoh-koo" },
      { english: "Father", japanese: "お父さん", romaji: "Otō-san", pronunciation: "oh-toh-san" },
      { english: "Mother", japanese: "お母さん", romaji: "Okā-san", pronunciation: "oh-kah-san" },
      { english: "Older brother", japanese: "お兄さん", romaji: "Onii-san", pronunciation: "oh-nee-san" },
      { english: "Older sister", japanese: "お姉さん", romaji: "Onee-san", pronunciation: "oh-neh-san" },
      { english: "Younger brother", japanese: "弟", romaji: "Otōto", pronunciation: "oh-toh-toh" },
      { english: "Younger sister", japanese: "妹", romaji: "Imōto", pronunciation: "ee-moh-toh" },
      { english: "Adults", japanese: "大人", romaji: "Otona", pronunciation: "oh-toh-nah" },
      { english: "Children", japanese: "子供", romaji: "Kodomo", pronunciation: "koh-doh-moh" },
      { english: "Boyfriend", japanese: "彼氏", romaji: "Kareshi", pronunciation: "kah-reh-shee" },
      { english: "Girlfriend", japanese: "彼女", romaji: "Kanojo", pronunciation: "kah-noh-joh" },
      { english: "Man", japanese: "男の人", romaji: "Otoko no hito", pronunciation: "oh-toh-koh noh hee-toh" },
      { english: "Woman", japanese: "女の人", romaji: "Onna no hito", pronunciation: "ohn-nah noh hee-toh" }
    ],
    "Food & Drink": [
      { english: "Breakfast", japanese: "朝ご飯", romaji: "Asa-gohan", pronunciation: "ah-sah goh-hahn" },
      { english: "Lunch", japanese: "昼ご飯", romaji: "Hiru-gohan", pronunciation: "hee-roo goh-hahn" },
      { english: "Dinner", japanese: "夜ご飯", romaji: "Yoru-gohan", pronunciation: "yoh-roo goh-hahn" },
      { english: "Rice / Meal", japanese: "ご飯", romaji: "Gohan", pronunciation: "goh-hahn" },
      { english: "Bread", japanese: "パン", romaji: "Pan", pronunciation: "pahn" },
      { english: "Meat", japanese: "肉", romaji: "Niku", pronunciation: "nee-koo" },
      { english: "Fish", japanese: "魚", romaji: "Sakana", pronunciation: "sah-kah-nah" },
      { english: "Vegetables", japanese: "野菜", romaji: "Yasai", pronunciation: "yah-sigh" },
      { english: "Fruits", japanese: "果物", romaji: "Kudamono", pronunciation: "koo-dah-moh-noh" },
      { english: "Soup", japanese: "スープ", romaji: "Sūpu", pronunciation: "soo-poo" },
      { english: "Salad", japanese: "サラダ", romaji: "Sarada", pronunciation: "sah-rah-dah" },
      { english: "Egg", japanese: "卵", romaji: "Tamago", pronunciation: "tah-mah-goh" },
      { english: "Milk", japanese: "牛乳", romaji: "Gyūnyū", pronunciation: "gyoo-nyoo" },
      { english: "Cheese", japanese: "チーズ", romaji: "Chīzu", pronunciation: "chee-zoo" },
      { english: "Dessert", japanese: "デザート", romaji: "Dezāto", pronunciation: "deh-zah-toh" },
      { english: "Water", japanese: "水", romaji: "Mizu", pronunciation: "mee-zoo" },
      { english: "Tea / Green tea", japanese: "お茶", romaji: "Ocha", pronunciation: "oh-chah" },
      { english: "Coffee", japanese: "コーヒー", romaji: "Kōhī", pronunciation: "koh-hee" },
      { english: "Alcohol / Sake", japanese: "お酒", romaji: "Osake", pronunciation: "oh-sah-keh" },
      { english: "Wine", japanese: "ワイン", romaji: "Wain", pronunciation: "wah-een" },
      { english: "Beer", japanese: "ビール", romaji: "Bīru", pronunciation: "bee-roo" }
    ],
    "Numbers": [
      { english: "1", japanese: "一", romaji: "ichi", pronunciation: "ee-chee" },
      { english: "2", japanese: "二", romaji: "ni", pronunciation: "nee" },
      { english: "3", japanese: "三", romaji: "san", pronunciation: "sahn" },
      { english: "4", japanese: "四", romaji: "yon", pronunciation: "yohn" },
      { english: "5", japanese: "五", romaji: "go", pronunciation: "goh" },
      { english: "6", japanese: "六", romaji: "roku", pronunciation: "roh-koo" },
      { english: "7", japanese: "七", romaji: "nana", pronunciation: "nah-nah" },
      { english: "8", japanese: "八", romaji: "hachi", pronunciation: "hah-chee" },
      { english: "9", japanese: "九", romaji: "kyū", pronunciation: "kyoo" },
      { english: "10", japanese: "十", romaji: "jū", pronunciation: "joo" },
      { english: "11", japanese: "十一", romaji: "jūichi", pronunciation: "joo-ee-chee" },
      { english: "12", japanese: "十二", romaji: "jūni", pronunciation: "joo-nee" },
      { english: "20", japanese: "二十", romaji: "nijū", pronunciation: "nee-joo" },
      { english: "21", japanese: "二十一", romaji: "nijūichi", pronunciation: "nee-joo-ee-chee" },
      { english: "30", japanese: "三十", romaji: "sanjū", pronunciation: "sahn-joo" },
      { english: "32", japanese: "三十二", romaji: "sanjūni", pronunciation: "sahn-joo-nee" },
      { english: "40", japanese: "四十", romaji: "yonjū", pronunciation: "yohn-joo" },
      { english: "43", japanese: "四十三", romaji: "yonjūsan", pronunciation: "yohn-joo-sahn" },
      { english: "50", japanese: "五十", romaji: "gojū", pronunciation: "goh-joo" },
      { english: "54", japanese: "五十四", romaji: "gojūyon", pronunciation: "goh-joo-yohn" },
      { english: "60", japanese: "六十", romaji: "rokujū", pronunciation: "roh-koo-joo" },
      { english: "65", japanese: "六十五", romaji: "rokujūgo", pronunciation: "roh-koo-joo-goh" },
      { english: "70", japanese: "七十", romaji: "nanajū", pronunciation: "nah-nah-joo" },
      { english: "76", japanese: "七十六", romaji: "nanajūroku", pronunciation: "nah-nah-joo-roh-koo" },
      { english: "80", japanese: "八十", romaji: "hachijū", pronunciation: "hah-chee-joo" },
      { english: "87", japanese: "八十七", romaji: "hachijūnana", pronunciation: "hah-chee-joo-nah-nah" },
      { english: "90", japanese: "九十", romaji: "kyūjū", pronunciation: "kyoo-joo" },
      { english: "98", japanese: "九十八", romaji: "kyūjūhachi", pronunciation: "kyoo-joo-hah-chee" },
      { english: "100", japanese: "百", romaji: "hyaku", pronunciation: "hyah-koo" },
      { english: "1000", japanese: "千", romaji: "sen", pronunciation: "sen" },
      { english: "2000", japanese: "二千", romaji: "nisen", pronunciation: "nee-sen" },
      { english: "3000", japanese: "三千", romaji: "sanzen", pronunciation: "sahn-zen" },
      { english: "5000", japanese: "五千", romaji: "gosen", pronunciation: "goh-sen" }
    ],
    "Essential Verbs": [
      { english: "to eat", japanese: "食べる", romaji: "Taberu", pronunciation: "tah-beh-roo" },
      { english: "to go", japanese: "行く", romaji: "Iku", pronunciation: "ee-koo" },
      { english: "to drink", japanese: "飲む", romaji: "Nomu", pronunciation: "noh-moo" },
      { english: "to listen / hear", japanese: "聞く", romaji: "Kiku", pronunciation: "kee-koo" },
      { english: "to read", japanese: "読む", romaji: "Yomu", pronunciation: "yoh-moo" },
      { english: "to see / look / watch", japanese: "見る", romaji: "Miru", pronunciation: "mee-roo" },
      { english: "to sleep", japanese: "寝る", romaji: "Neru", pronunciation: "neh-roo" },
      { english: "to wake up", japanese: "起きる", romaji: "Okiru", pronunciation: "oh-kee-roo" },
      { english: "to speak / talk", japanese: "話す", romaji: "Hanasu", pronunciation: "hah-nah-soo" },
      { english: "to return / go back", japanese: "帰る", romaji: "Kaeru", pronunciation: "kah-eh-roo" },
      { english: "to sit down", japanese: "座る", romaji: "Suwaru", pronunciation: "soo-wah-roo" },
      { english: "to stand up", japanese: "立つ", romaji: "Tatsu", pronunciation: "tah-tsoo" },
      { english: "to swim", japanese: "泳ぐ", romaji: "Oyogu", pronunciation: "oh-yoh-goo" },
      { english: "to play", japanese: "遊ぶ", romaji: "Asobu", pronunciation: "ah-soh-boo" },
      { english: "to ride", japanese: "乗る", romaji: "Noru", pronunciation: "noh-roo" },
      { english: "to buy", japanese: "買う", romaji: "Kau", pronunciation: "kah-oo" },
      { english: "to meet", japanese: "会う", romaji: "Au", pronunciation: "ah-oo" },
      { english: "to write", japanese: "書く", romaji: "Kaku", pronunciation: "kah-koo" },
      { english: "to wait", japanese: "待つ", romaji: "Matsu", pronunciation: "mah-tsoo" },
      { english: "to take a picture", japanese: "撮る", romaji: "Toru", pronunciation: "toh-roo" }
    ]
  }
};

const HIRAGANA = [
  ["あ","a","ah"],["い","i","ee"],["う","u","oo"],["え","e","eh"],["お","o","oh"],
  ["か","ka","kah"],["き","ki","kee"],["く","ku","koo"],["け","ke","keh"],["こ","ko","koh"],
  ["さ","sa","sah"],["し","shi","shee"],["す","su","soo"],["せ","se","seh"],["そ","so","soh"],
  ["た","ta","tah"],["ち","chi","chee"],["つ","tsu","tsoo"],["て","te","teh"],["と","to","toh"],
  ["な","na","nah"],["に","ni","nee"],["ぬ","nu","noo"],["ね","ne","neh"],["の","no","noh"],
  ["は","ha","hah"],["ひ","hi","hee"],["ふ","fu","foo"],["へ","he","heh"],["ほ","ho","hoh"],
  ["ま","ma","mah"],["み","mi","mee"],["む","mu","moo"],["め","me","meh"],["も","mo","moh"],
  ["や","ya","yah"],["ゆ","yu","yoo"],["よ","yo","yoh"],
  ["ら","ra","rah"],["り","ri","ree"],["る","ru","roo"],["れ","re","reh"],["ろ","ro","roh"],
  ["わ","wa","wah"],["を","wo (o)","woh"],["ん","n","n"]
];

const KATAKANA = [
  ["ア","a","ah"],["イ","i","ee"],["ウ","u","oo"],["エ","e","eh"],["オ","o","oh"],
  ["カ","ka","kah"],["キ","ki","kee"],["ク","ku","koo"],["ケ","ke","keh"],["コ","ko","koh"],
  ["サ","sa","sah"],["シ","shi","shee"],["ス","su","soo"],["セ","se","seh"],["ソ","so","soh"],
  ["タ","ta","tah"],["チ","chi","chee"],["ツ","tsu","tsoo"],["テ","te","teh"],["ト","to","toh"],
  ["ナ","na","nah"],["ニ","ni","nee"],["ヌ","nu","noo"],["ネ","ne","neh"],["ノ","no","noh"],
  ["ハ","ha","hah"],["ヒ","hi","hee"],["フ","fu","foo"],["ヘ","he","heh"],["ホ","ho","hoh"],
  ["マ","ma","mah"],["ミ","mi","mee"],["ム","mu","moo"],["メ","me","meh"],["モ","mo","moh"],
  ["ヤ","ya","yah"],["ユ","yu","yoo"],["ヨ","yo","yoh"],
  ["ラ","ra","rah"],["リ","ri","ree"],["ル","ru","roo"],["レ","re","reh"],["ロ","ro","roh"],
  ["ワ","wa","wah"],["ヲ","wo (o)","woh"],["ン","n","n"]
];

const KANJI = [
  {j:"一",e:"One",r:"ichi"},{j:"二",e:"Two",r:"ni"},{j:"三",e:"Three",r:"san"},{j:"四",e:"Four",r:"yon"},{j:"五",e:"Five",r:"go"},
  {j:"六",e:"Six",r:"roku"},{j:"七",e:"Seven",r:"nana"},{j:"八",e:"Eight",r:"hachi"},{j:"九",e:"Nine",r:"kyū"},{j:"十",e:"Ten",r:"jū"},
  {j:"人",e:"Person",r:"hito"},{j:"今",e:"Now",r:"ima"},{j:"日",e:"Day/Sun",r:"hi/nichi"},{j:"週",e:"Week",r:"shū"},{j:"月",e:"Month/Moon",r:"tsuki/getsu"},
  {j:"年",e:"Year",r:"toshi/nen"},{j:"中",e:"Inside/Middle",r:"naka/chū"},{j:"山",e:"Mountain",r:"yama"},{j:"川",e:"River",r:"kawa"},
  {j:"左",e:"Left",r:"hidari"},{j:"右",e:"Right",r:"migi"},{j:"大",e:"Big",r:"ōkī/dai"},{j:"木",e:"Tree",r:"ki"},{j:"本",e:"Book/Root",r:"hon"},
  {j:"水",e:"Water",r:"mizu"},{j:"火",e:"Fire",r:"hi"},{j:"父",e:"Father",r:"chichi"},{j:"母",e:"Mother",r:"haha"},
  {j:"耳",e:"Ear",r:"mimi"},{j:"口",e:"Mouth",r:"kuchi"},{j:"休",e:"Rest",r:"yasumu"},{j:"何",e:"What",r:"nani"},{j:"入",e:"Enter",r:"hairu"},
  {j:"上",e:"Up/Above",r:"ue"},{j:"前",e:"Before/Front",r:"mae"},{j:"下",e:"Down/Below",r:"shita"},{j:"千",e:"Thousand",r:"sen"},
  {j:"午",e:"Noon",r:"go"},{j:"友",e:"Friend",r:"tomo"},{j:"古",e:"Old",r:"furui"},{j:"名",e:"Name",r:"na"},{j:"国",e:"Country",r:"kuni"},
  {j:"外",e:"Outside",r:"soto/gai"},{j:"女",e:"Woman",r:"onna"},{j:"男",e:"Man",r:"otoko"},{j:"子",e:"Child",r:"ko"},
  {j:"学",e:"Study",r:"gaku"},{j:"生",e:"Life/Born",r:"sei/iki"},{j:"小",e:"Small",r:"chīsai"},{j:"書",e:"Write",r:"kaku"},{j:"毎",e:"Every",r:"mai"},
  {j:"先",e:"Previous/Ahead",r:"saki/sen"},{j:"会",e:"Meet",r:"au/kai"},{j:"万",e:"Ten Thousand",r:"man"},{j:"円",e:"Yen/Circle",r:"en"},
  {j:"出",e:"Exit",r:"deru"},{j:"分",e:"Minute/Part",r:"fun/bun"},{j:"北",e:"North",r:"kita"},{j:"半",e:"Half",r:"han"},{j:"南",e:"South",r:"minami"},
  {j:"土",e:"Earth/Soil",r:"tsuchi"},{j:"多",e:"Many",r:"ōi"},{j:"天",e:"Heaven",r:"ten"},{j:"安",e:"Cheap/Safe",r:"yasui"},{j:"少",e:"Few",r:"sukunai"},
  {j:"店",e:"Shop",r:"mise"},{j:"後",e:"After",r:"ato/go"},{j:"手",e:"Hand",r:"te"},{j:"新",e:"New",r:"atarashī"},{j:"時",e:"Time",r:"toki/ji"},
  {j:"来",e:"Come",r:"kuru/rai"},{j:"東",e:"East",r:"higashi"},{j:"校",e:"School",r:"kō"},{j:"気",e:"Spirit/Air",r:"ki"},{j:"白",e:"White",r:"shiro"},
  {j:"百",e:"Hundred",r:"hyaku"},{j:"目",e:"Eye",r:"me"},{j:"社",e:"Company/Shrine",r:"sha"},{j:"空",e:"Sky/Empty",r:"sora"},{j:"立",e:"Stand",r:"tatsu"},
  {j:"聞",e:"Listen",r:"kiku"},{j:"花",e:"Flower",r:"hana"},{j:"行",e:"Go",r:"iku"},{j:"西",e:"West",r:"nishi"},{j:"見",e:"See",r:"miru"},
  {j:"言",e:"Say",r:"iu"},{j:"話",e:"Speak",r:"hanasu"},{j:"語",e:"Language",r:"go"},{j:"読",e:"Read",r:"yomu"},
  {j:"買",e:"Buy",r:"kau"},{j:"足",e:"Leg/Foot",r:"ashi"},{j:"車",e:"Car",r:"kuruma"},{j:"道",e:"Road",r:"michi"},{j:"金",e:"Gold/Money",r:"kane/kin"},
  {j:"長",e:"Long",r:"nagai"},{j:"間",e:"Interval/Between",r:"aida/kan"},{j:"雨",e:"Rain",r:"ame"},{j:"電",e:"Electricity",r:"den"},
  {j:"食",e:"Eat",r:"taberu/shoku"},{j:"飲",e:"Drink",r:"nomu"},{j:"駅",e:"Station",r:"eki"},{j:"高",e:"High/Expensive",r:"takai"},{j:"魚",e:"Fish",r:"sakana"}
];
/* --- EMBEDDED DATA END --- */

function slug(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }

function buildCardsFromVocab(setName) {
  const out = [];
  const categories = VOCAB[setName] || {};
  for (const [cat, items] of Object.entries(categories)) {
    for (const item of items) {
      const id = `${slug(setName)}:${slug(cat)}:${slug(item.english)}:${slug(item.japanese)}`;
      out.push({ id, set: setName, category: cat, type: "vocab",
        english: item.english, japanese: item.japanese, romaji: item.romaji, pronunciation: item.pronunciation
      });
    }
  }
  return out;
}

function buildKanaCards(setName, kanaArr) {
  return kanaArr.map(([ch, romaji, pron]) => ({
    id: `${slug(setName)}:kana:${slug(ch)}:${slug(romaji)}`,
    set: setName, category: "Gojūon", type: "kana",
    english: romaji, japanese: ch, romaji, pronunciation: pron
  }));
}

function buildKanjiCards(setName, kanjiArr) {
  return kanjiArr.map(k => ({
    id: `${slug(setName)}:kanji:${slug(k.j)}`,
    set: setName, category: "Kanji", type: "kanji",
    english: k.e, japanese: k.j, romaji: k.r, pronunciation: k.r
  }));
}

function dedupeCards(cards) {
  const seen = new Set();
  const out = [];
  for (const c of cards) {
    const key = `${c.type}|${c.japanese}|${c.english}|${c.romaji}`;
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(c);
  }
  return out;
}

function shuffleInPlace(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// state
let deckAll = [];
let deckView = [];
let index = 0;
let isFront = true;
let unsureLocked = false;
let showHintOnFront = false;
let perCardFrontIsEnglish = new Map();
let mobileSettingsOpen = false;
const missed = new Set();

// Progress & Streak
let currentStreak = 0;
let answerHistory = []; // Array of 'correct' | 'incorrect'
let correctCount = 0;

// speech
let speechSupported = false;
let jaVoice = null;

// DOM
const el = (id) => document.getElementById(id);
const cardEl = el("card");
const bigEl = el("big");
const midJpEl = el("mid_jp");
const midTxtEl = el("mid_txt");
const smallEl = el("small");
const badgeLeft = el("badge_left");
const badgeRight = el("badge_right");
const statsEl = el("stats");
const toastEl = el("toast");
const missCountEl = el("missCount");
const byCategoryEl = el("by_category");
const cardActionsEl = el("card_actions");
const controlsArea = el("controls_area");
const progressText = el("progress_text");
const progressTrack = el("progress_track");
const streakContainer = el("streak_container");

const selAllVocab = el("sel_all_vocab");
const selAllScripts = el("sel_all_scripts");
const selEssentials = el("sel_essentials");
const selTravel = el("sel_travel");
const selBasic = el("sel_basic");
const selHira = el("sel_hira");
const selKata = el("sel_kata");
const selKanji = el("sel_kanji");

const optShuffle = el("opt_shuffle");
const optLimitSelect = el("opt_limit_select");
const optSideMode = el("opt_side_mode");
const optIncorrectOnly = el("opt_incorrectOnly");

const btnSpeak = el("btn_speak");
const btnHint = el("btn_hint");
const btnSettings = el("btn_settings");
const btnCloseSettings = el("btn_closeSettings");
const btnPrev = el("btn_prev");
const btnNext = el("btn_next");
const btnFlip = el("btn_flip");
const btnCorrect = el("btn_correct");
const btnUnsure = el("btn_unsure");
const btnIncorrect = el("btn_incorrect");


function showToast(msg, type) {
  if (!msg) {
    toastEl.textContent = "";
    toastEl.className = "toast";
    return;
  }
  toastEl.textContent = msg;
  toastEl.className = "toast visible " + (type || "");
  setTimeout(() => { 
    if (toastEl.textContent === msg) {
        toastEl.classList.remove("visible");
    }
  }, 2000);
}

function updateMissCount() { missCountEl.textContent = `Incorrect: ${missed.size}`; }

function selectedSets() {
  const sets = [];
  if (selEssentials.checked) sets.push(SETS.ESSENTIALS);
  if (selTravel.checked) sets.push(SETS.TRAVEL);
  if (selBasic.checked) sets.push(SETS.BASIC);
  if (selHira.checked) sets.push(SETS.HIRAGANA);
  if (selKata.checked) sets.push(SETS.KATAKANA);
  if (selKanji.checked) sets.push(SETS.KANJI);
  return sets;
}


function updateActionState() {
  const hasDeck = deckView && deckView.length > 0;
  const isDone = index >= deckView.length;

  if (isDone) {
    btnPrev.disabled = false; // allow going back to review
    btnNext.disabled = true;
    btnFlip.disabled = true;
    cardActionsEl.classList.add("hidden");
    if (btnHint) btnHint.disabled = true;
    return;
  }

  cardActionsEl.classList.remove("hidden");
  btnPrev.disabled = !hasDeck || index === 0;
  btnNext.disabled = !hasDeck || isDone; // Should be impossible if linear
  btnFlip.disabled = !hasDeck;

  const showUnsure = hasDeck && isFront && !unsureLocked;
  const showGrade = hasDeck && !isFront && !unsureLocked;

  btnUnsure.classList.toggle("hidden", !showUnsure);
  btnCorrect.classList.toggle("hidden", !showGrade);
  btnIncorrect.classList.toggle("hidden", !showGrade);

  btnCorrect.disabled = !showGrade;
  btnIncorrect.disabled = !showGrade;
  btnUnsure.disabled = !showUnsure;

  if (btnHint) btnHint.disabled = !hasDeck || !isFront;
}


function applyIncorrectOnlyView() {
  if (!deckAll.length) { deckView = []; return; }
  if (!optIncorrectOnly.checked) { deckView = deckAll.slice(); return; }
  deckView = deckAll.filter(c => missed.has(c.id));
  if (deckView.length === 0) showToast("No incorrect cards yet.", "warn");
}

function getAllAvailableCategories() {
  const cats = new Set();
  for (const setName of Object.keys(VOCAB)) {
    for (const catName of Object.keys(VOCAB[setName] || {})) cats.add(catName);
  }
  cats.add("Gojūon");
  cats.add("Kanji");
  return Array.from(cats).sort((a,b) => a.localeCompare(b));
}

function populateCategoryDropdown() {
  const categories = getAllAvailableCategories();
  byCategoryEl.innerHTML = `<option value="">(None)</option>` +
    categories.map(c => `<option value="${c}">${c}</option>`).join("");
}

function buildDeckByCategory(category) {
  let cards = [];
  for (const setName of Object.keys(VOCAB)) {
    const cats = VOCAB[setName] || {};
    if (cats[category]) {
      for (const item of cats[category]) {
        const id = `${slug(setName)}:${slug(category)}:${slug(item.english)}:${slug(item.japanese)}`;
        cards.push({ id, set: setName, category, type: "vocab",
          english: item.english, japanese: item.japanese, romaji: item.romaji, pronunciation: item.pronunciation
        });
      }
    }
  }
  if (category === "Gojūon") {
    cards.push(...buildKanaCards(SETS.HIRAGANA, HIRAGANA));
    cards.push(...buildKanaCards(SETS.KATAKANA, KATAKANA));
  }
  if (category === "Kanji") {
    cards.push(...buildKanjiCards(SETS.KANJI, KANJI));
  }
  cards = dedupeCards(cards);
  const limit = parseInt(optLimitSelect.value, 10);
  if (optShuffle.checked) shuffleInPlace(cards);
  if (limit > 0) cards = cards.slice(0, limit);
  return cards;
}

function rebuildDeck() {
  const overrideCategory = byCategoryEl.value;
  let cards = [];

  if (overrideCategory) {
    cards = buildDeckByCategory(overrideCategory);
    showToast(`By Category override: ${overrideCategory}`);
  } else {
    const sets = selectedSets();
    if (sets.length === 0) {
      deckAll = []; deckView = []; index = 0; isFront = true;
      showHintOnFront = false;
      mobileSettingsOpen = false;
      document.body.classList.remove("studying","showSettings");
      render();
      showToast("Select at least one set (or choose By Category).", "warn");
      return;
    }
    for (const s of sets) {
      if (s === SETS.HIRAGANA) cards.push(...buildKanaCards(SETS.HIRAGANA, HIRAGANA));
      else if (s === SETS.KATAKANA) cards.push(...buildKanaCards(SETS.KATAKANA, KATAKANA));
      else if (s === SETS.KANJI) cards.push(...buildKanjiCards(SETS.KANJI, KANJI));
      else cards.push(...buildCardsFromVocab(s));
    }
    cards = dedupeCards(cards);
    const limit = parseInt(optLimitSelect.value, 10);
    if (optShuffle.checked) shuffleInPlace(cards);
    if (limit > 0) cards = cards.slice(0, limit);
  }

  deckAll = cards;
  // FIX: Clear randomization history on new deck build
  perCardFrontIsEnglish = new Map();
  index = 0;
  isFront = true;
  showHintOnFront = false;
  mobileSettingsOpen = false;
  document.body.classList.remove("studying","showSettings");
  
  // Reset Progress
  currentStreak = 0;
  answerHistory = [];
  correctCount = 0;

  applyIncorrectOnlyView();
  showToast(`Built deck with ${deckAll.length} cards.`);
  render();
}

function computeFrontForCard(card) {
  const mode = optSideMode.value;
  
  if (mode === "jp") return false; // Force Japanese Side
  if (mode === "en") return true;  // Force English Side

  // RANDOM MODE LOGIC
  // If random, allow Scripts (Kana/Kanji) to default to Japanese side, unless manually flipped later
  if (card.type === "kana" || card.type === "kanji") return false;

  // Otherwise, random for vocab
  if (perCardFrontIsEnglish.has(card.id)) return perCardFrontIsEnglish.get(card.id);
  const val = Math.random() < 0.5;
  perCardFrontIsEnglish.set(card.id, val);
  return val;
}

function faceContent(card, showEnglishFace) {
  // KANA
  if (card.type === "kana") {
    if (showEnglishFace) {
      return { big: card.romaji.toUpperCase(), mid: `Pronunciation: ${card.pronunciation}`, small: card.japanese };
    } else {
      return { big: card.japanese, mid: "", small: "" };
    }
  }

  // KANJI
  if (card.type === "kanji") {
    if (showEnglishFace) {
      return { big: card.english, mid: `Reading: ${card.romaji}`, small: card.japanese };
    } else {
      return { big: card.japanese, mid: "", small: "" };
    }
  }

  // VOCAB
  if (showEnglishFace) return { big: card.english, mid: "", small: "" };

  return {
    big: card.romaji || "",
    mid: card.japanese || "",
    small: `Pronunciation: ${card.pronunciation || ""}`
  };
}

/* Progress Logic */
function renderProgress() {
  const total = deckView.length || 1;
  const answered = answerHistory.length;
  
  // Text Above
  progressText.textContent = `${correctCount} / ${answered} Correct`;

  // Bar
  const segments = answerHistory.map(type => {
    return `<div class="progress-segment ${type === 'correct' ? 'seg-green' : 'seg-red'}" style="width: ${100/total}%"></div>`;
  }).join("");
  progressTrack.innerHTML = segments;

  // Streak Text Below
  let html = "";
  if (currentStreak >= 5) {
      // Check for multiples of 5
      if (currentStreak % 5 === 0) {
          html = `<div class="streak-icon">🔥</div><div>${currentStreak} in a row!</div>`;
      } else {
          html = `<div class="streak-icon">🔥</div><div>${currentStreak} streak</div>`;
      }
  } else if (currentStreak <= -5) {
      if (currentStreak % 5 === 0) {
          html = `<div class="streak-icon">💩</div><div>${Math.abs(currentStreak)} misses in a row</div>`;
      } else {
          html = `<div class="streak-icon">💩</div><div>${Math.abs(currentStreak)} miss streak</div>`;
      }
  }
  streakContainer.innerHTML = html;
}

/* UI actions */
function render() {
  updateMissCount();
  renderProgress();

  const isMobile = window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
  const hasBuiltDeck = deckAll && deckAll.length > 0;
  document.body.classList.toggle("studying", !!(isMobile && hasBuiltDeck));
  if (typeof updateSettingsButtons === "function") updateSettingsButtons();

  if (!deckView || deckView.length === 0) {
    badgeLeft.textContent = "—";
    badgeRight.textContent = optIncorrectOnly.checked ? "Incorrect Only" : "—";
    bigEl.textContent = deckAll.length ? "No cards in this view" : "Build a deck to start";
    midJpEl.classList.add("hidden");
    midJpEl.textContent = "";
    midTxtEl.classList.remove("hidden");
    midTxtEl.textContent = deckAll.length
      ? "You have no incorrect cards yet (or you cleared them)."
      : "Select sets on the left, then click Build Deck.";
    smallEl.textContent = "";
    statsEl.textContent = deckAll.length
      ? `Deck: ${deckAll.length} · Incorrect: ${missed.size}`
      : "Deck not built yet.";

    el("btn_prev").disabled = true;
    el("btn_next").disabled = true;
    el("btn_flip").disabled = true;

    btnSpeak.classList.add("hidden");
    btnSpeak.disabled = true;
    
    // Reset progress/streak visuals if no deck
    progressTrack.innerHTML = "";
    streakContainer.innerHTML = "";
    progressText.textContent = "0 / 0 Correct";

    updateActionState();
    return;
  }

  // CHECK FOR DONE STATE
  if (index >= deckView.length) {
    badgeLeft.textContent = "Finished";
    badgeRight.textContent = "";
    bigEl.textContent = "Done";
    midJpEl.classList.add("hidden");
    midTxtEl.classList.remove("hidden");
    
    let subHtml = `You have completed this deck.<br/><br/>`;
    
    if (missed.size > 0) {
        subHtml += `<button id="btn_review_missed" class="bad" style="margin-bottom:10px;">Review Incorrect Cards (${missed.size})</button><br/>`;
    }
    
    subHtml += `<button id="btn_restart" class="ghost">Restart Deck</button>`;
    
    midTxtEl.innerHTML = subHtml;
    smallEl.textContent = "";
    statsEl.textContent = `Completed ${deckView.length} cards.`;
    
    btnSpeak.classList.add("hidden");
    
    // Wire up buttons
    setTimeout(() => {
        const btnReview = document.getElementById("btn_review_missed");
        if (btnReview) {
            btnReview.onclick = () => {
                optIncorrectOnly.checked = true;
                applyIncorrectOnlyView();
                // Reset progress for the review session
                index = 0; currentStreak = 0; answerHistory = []; correctCount = 0;
                // FIX: Clear randomization history
                perCardFrontIsEnglish = new Map();
                render();
            };
        }
        const btnRestart = document.getElementById("btn_restart");
        if (btnRestart) {
            btnRestart.onclick = () => {
                index = 0; currentStreak = 0; answerHistory = []; correctCount = 0;
                isFront = true;
                // FIX: Clear randomization history on restart so it's truly random again
                perCardFrontIsEnglish = new Map();
                shuffleInPlace(deckView); 
                render();
            };
        }
    }, 0);

    updateActionState();
    return;
  }

  const card = deckView[index];
  const frontIsEnglish = computeFrontForCard(card);
  const showEnglishFace = isFront ? frontIsEnglish : !frontIsEnglish;
  const japaneseFaceShowing = !showEnglishFace;

  const content = faceContent(card, showEnglishFace);

  badgeLeft.textContent = `${card.set}`;
  badgeRight.textContent = `${card.category}${optIncorrectOnly.checked ? " · Incorrect Only" : ""}`;

  const hideMeta = isFront && !showHintOnFront;
  badgeLeft.classList.toggle("hidden", hideMeta);
  badgeRight.classList.toggle("hidden", hideMeta);
  if (btnHint) btnHint.classList.toggle("hidden", !isFront);

  bigEl.textContent = content.big;
  
  // Apply Super Big class for Kana/Kanji characters on Japanese face (Front)
  if ((card.type === "kana" || card.type === "kanji") && japaneseFaceShowing) {
    bigEl.classList.add("super-big");
  } else {
    bigEl.classList.remove("super-big");
  }

  const isVocabJapaneseFace = (card.type === "vocab") && japaneseFaceShowing;
  if (isVocabJapaneseFace && content.mid) {
    midJpEl.textContent = content.mid;
    midJpEl.classList.remove("hidden");
    midTxtEl.classList.add("hidden");
    midTxtEl.textContent = "";
  } else {
    midJpEl.classList.add("hidden");
    midJpEl.textContent = "";
    midTxtEl.classList.remove("hidden");
    midTxtEl.textContent = content.mid || (isFront ? "Click to flip" : "");
  }

  smallEl.textContent = content.small || "";

  // Apply "kana-sub" class for Kana/Kanji characters on English face (Back)
  if ((card.type === "kana" || card.type === "kanji") && showEnglishFace) {
    smallEl.classList.add("kana-sub");
  } else {
    smallEl.classList.remove("kana-sub");
  }

  // Simplified Card Stats
  statsEl.textContent = `Card ${index + 1} / ${deckView.length} · ${isFront ? "Front" : "Back"}`;

  updateActionState();

  /* UPDATE: Audio Logic */
  let canSpeakNow = false;
  if (speechSupported) {
    if (card.type === "kana" || card.type === "kanji") {
        // Scripts: Speak only if showing English (Back/Answer) side
        canSpeakNow = showEnglishFace;
    } else {
        // Vocab: Speak only if showing Japanese side
        canSpeakNow = japaneseFaceShowing;
    }
  }
  
  btnSpeak.classList.toggle("hidden", !canSpeakNow);
  btnSpeak.disabled = !canSpeakNow;
  
  // Autoplay
  if (canSpeakNow && card) {
    setTimeout(() => {
       speakJapaneseForCard(card);
    }, 50);
  }
}

function flip() {
  showHintOnFront = false;
  unsureLocked = false;
  if (!deckView.length) return;
  isFront = !isFront;
  render();
}

// Linear navigation
function next() {
  showHintOnFront = false;
  unsureLocked = false;
  if (!deckView.length) return;
  // Stop at the end
  if (index < deckView.length) {
      index++;
  }
  isFront = true;
  showHintOnFront = false;
  mobileSettingsOpen = false;
  document.body.classList.remove("studying","showSettings"); 
  render(); 
}

function prev() {
  showHintOnFront = false;
  if (!deckView.length) return;
  // Prevent going below 0
  if (index > 0) {
      index--;
      // Remove last history entry logic?
      // Simplified: Just go back, history remains (user can overwrite answer).
      // If we go back, we don't necessarily undo streaks/score immediately unless they re-answer.
      // But for simple "undo", let's pop history
      const lastAnswer = answerHistory.pop();
      if(lastAnswer === 'correct') correctCount--;
      
      // Reset streak logic is complex on back, simplified: just decrement count if it was pos
      if(currentStreak > 0) currentStreak--;
      else if(currentStreak < 0) currentStreak++;
  }
  isFront = true;
  showHintOnFront = false;
  mobileSettingsOpen = false;
  document.body.classList.remove("studying","showSettings"); 
  render(); 
}


function markCorrect() {
  if (!deckView.length) return;
  if (isFront) { showToast("Flip first to see the answer.", "warn"); return; }
  
  // Streak Logic: Correct
  if (currentStreak < 0) currentStreak = 0; // Reset negative streak
  currentStreak++;
  answerHistory.push('correct');
  correctCount++;

  showToast("Correct!", "good");
  next();
}


function markIncorrect() {
  if (!deckView.length) return;
  if (isFront) { showToast("Flip first to see the answer.", "warn"); return; }
  const card = deckView[index];
  missed.add(card.id);
  applyIncorrectOnlyView();
  
  // Streak Logic: Incorrect
  if (currentStreak > 0) currentStreak = 0; // Reset positive streak
  currentStreak--;
  answerHistory.push('incorrect');

  showToast("Incorrect", "bad");
  next();
}


function markUnsure() {
  if (!deckView.length) return;
  const card = deckView[index];
  missed.add(card.id);
  applyIncorrectOnlyView();

  if (isFront) {
    isFront = false;
    unsureLocked = true;
    showToast("Unsure → marked incorrect. (Flipped to answer)", "warn");
    render();
  } else {
    // Treat unsure as incorrect for streak/progress
    if (currentStreak > 0) currentStreak = 0;
    currentStreak--;
    answerHistory.push('incorrect');

    showToast("Unsure → Incorrect", "warn");
    next();
  }
}


function clearMisses() { missed.clear(); applyIncorrectOnlyView(); index = 0; isFront = true;
  showHintOnFront = false;
  mobileSettingsOpen = false;
  document.body.classList.remove("studying","showSettings"); showToast("Cleared incorrect list."); render(); }


function resetUI() {
  selAllVocab.checked = false;
  selAllScripts.checked = false;
  selEssentials.checked = false;
  selTravel.checked = true;
  selBasic.checked = false;
  selHira.checked = false;
  selKata.checked = false;
  selKanji.checked = false;

  byCategoryEl.value = "";
  optShuffle.checked = true;
  optLimitSelect.value = "0";
  optSideMode.value = "random";
  optIncorrectOnly.checked = false;

  deckAll = [];
  deckView = [];
  index = 0;
  isFront = true;
  showHintOnFront = false;
  // FIX: Clear randomization history
  perCardFrontIsEnglish = new Map();
  missed.clear();
  
  currentStreak = 0;
  answerHistory = [];
  correctCount = 0;

  mobileSettingsOpen = false;
  document.body.classList.remove("studying","showSettings");

  if (speechSupported) window.speechSynthesis.cancel();

  render();
  showToast("Reset to defaults.");
}


function syncSelectAllVocab() {
  const allChecked = selEssentials.checked && selTravel.checked && selBasic.checked;
  const noneChecked = !selEssentials.checked && !selTravel.checked && !selBasic.checked;
  selAllVocab.indeterminate = !allChecked && !noneChecked;
  selAllVocab.checked = allChecked;
}

function syncSelectAllScripts() {
  const allChecked = selHira.checked && selKata.checked && selKanji.checked;
  const noneChecked = !selHira.checked && !selKata.checked && !selKanji.checked;
  selAllScripts.indeterminate = !allChecked && !noneChecked;
  selAllScripts.checked = allChecked;
}

selAllVocab.addEventListener("change", () => {
  const v = selAllVocab.checked;
  selEssentials.checked = v;
  selTravel.checked = v;
  selBasic.checked = v;
  syncSelectAllVocab();
});

selAllScripts.addEventListener("change", () => {
  const v = selAllScripts.checked;
  selHira.checked = v;
  selKata.checked = v;
  selKanji.checked = v;
  syncSelectAllScripts();
});

[selEssentials, selTravel, selBasic].forEach(cb => cb.addEventListener("change", syncSelectAllVocab));
[selHira, selKata, selKanji].forEach(cb => cb.addEventListener("change", syncSelectAllScripts));

el("btn_build").addEventListener("click", rebuildDeck);
el("btn_reset").addEventListener("click", resetUI);

el("btn_flip").addEventListener("click", flip);
el("btn_next").addEventListener("click", next);
el("btn_prev").addEventListener("click", prev);

el("btn_correct").addEventListener("click", (e) => { e.stopPropagation(); markCorrect(); });
el("btn_incorrect").addEventListener("click", (e) => { e.stopPropagation(); markIncorrect(); });
el("btn_unsure").addEventListener("click", (e) => { e.stopPropagation(); markUnsure(); });

btnSpeak.addEventListener("click", (e) => {
  e.stopPropagation();
  const card = getCurrentCard();
  if (!card) return;
  speakJapaneseForCard(card);
});

el("btn_clearMisses").addEventListener("click", clearMisses);

optIncorrectOnly.addEventListener("change", () => {
  applyIncorrectOnlyView();
  index = 0;
  isFront = true;
  render();
});

byCategoryEl.addEventListener("change", () => {
  if (byCategoryEl.value) showToast(`By Category selected: ${byCategoryEl.value} (will override on Build Deck)`);
  else showToast("By Category cleared. Using Study Sets.");
});


if (btnHint) {
  btnHint.addEventListener("click", (e) => {
    e.stopPropagation();
    if (!deckView.length) return;
    showHintOnFront = true;
    showToast("Hint: set/category revealed on the front.");
    render();
  });
}

if (btnSettings && btnCloseSettings) {
  function isMobileViewport(){ return window.matchMedia("(max-width: 720px)").matches; }
  function updateSettingsButtons(){
    const studying = document.body.classList.contains("studying") && isMobileViewport();
    btnSettings.classList.toggle("hidden", !studying);
    btnCloseSettings.classList.toggle("hidden", !(studying && mobileSettingsOpen));
  }
  function toggleSettingsOverlay(open){
    mobileSettingsOpen = (open !== undefined) ? !!open : !mobileSettingsOpen;
    document.body.classList.toggle("showSettings", mobileSettingsOpen);
    updateSettingsButtons();
  }
  btnSettings.addEventListener("click", (e)=>{ e.stopPropagation(); toggleSettingsOverlay(true); });
  btnCloseSettings.addEventListener("click", (e)=>{ e.stopPropagation(); toggleSettingsOverlay(false); });
  window.addEventListener("resize", updateSettingsButtons);
}

cardEl.addEventListener("click", flip);

window.addEventListener("keydown", (e) => {
  if (e.key === " " || e.code === "Space" || e.key === "ArrowUp" || e.key === "ArrowDown") {
    e.preventDefault();
    flip();
    return;
  }
  if (e.key === "ArrowRight") { next(); return; }
  if (e.key === "ArrowLeft") { prev(); return; }
});

populateCategoryDropdown();
syncSelectAllVocab();
syncSelectAllScripts();
initSpeech();
render();
</script>
</body>
</html>
