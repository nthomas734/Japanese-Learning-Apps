<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Japanese Flash Cards — v1.5.7 (Build 24)</title>

  <!--
    Japanese Flash Cards — v1.5.7 (Build 24)

    Changelog (latest first)
    - v1.5.7 (Build 24): Add Basic Japanese Words set (data); front-side Hint; hide set/category on front; enable mobile study mode; sync version metadata.
    - v1.5.6 (Build 23): Prior baseline (user-provided).
  -->

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121622;
      --panel2:#0f131d;
      --border:#22283a;
      --text:#e9ecf5;
      --muted:#aeb6cf;
      --muted2:#7f8aa9;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --bad:#ff5d6c;
      --warn:#ffcc66;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --pad:14px;
      --pad2:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(122,162,255,.28), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(61,220,151,.18), transparent 60%),
                  radial-gradient(900px 700px at 10% 60%, rgba(255,93,108,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    header{
      max-width:1200px;
      margin:0 auto;
      padding:18px 14px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      font-weight:720;
    }
    .title .sub{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badgeTop{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:8px 12px;
      border-radius:999px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      white-space:nowrap;
      font-size:13px;
      color:var(--muted);
      height:fit-content;
    }
    .badgeTop .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.15)),
                  var(--accent);
      box-shadow:0 0 0 4px rgba(122,162,255,.14);
    }
    .mono{font-family:var(--mono)}

    main{
      max-width:1200px;
      margin:0 auto;
      padding:14px 14px 28px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panel h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color:var(--text);
      font-weight:700;
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .panel .bd{ padding:14px; }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .row + .row{margin-top:10px}

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
    }
    .pill input{accent-color:var(--accent)}
    .pill label{font-size:13px; color:var(--muted); user-select:none}

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.10));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      letter-spacing:.15px;
      box-shadow:0 10px 22px rgba(0,0,0,.28);
      transition:transform .08s ease, filter .12s ease, opacity .12s ease;
    }
    button:hover{filter:brightness(1.04)}
    button:active{transform:translateY(1px)}
    button.primary{
      background:linear-gradient(180deg, rgba(122,162,255,.35), rgba(122,162,255,.14));
    }
    button.good{
      background:linear-gradient(180deg, rgba(61,220,151,.22), rgba(61,220,151,.10));
    }
    button.bad{
      background:linear-gradient(180deg, rgba(255,93,108,.22), rgba(255,93,108,.10));
    }
    button.warn{
      background:linear-gradient(180deg, rgba(255,204,102,.24), rgba(255,204,102,.10));
      color:#ffe7b0;
    }
    button.ghost{
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-weight:650;
      box-shadow:none;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    .small{font-size:12px; color:var(--muted2)}
    .muted{color:var(--muted); font-size:13px; line-height:1.35}

    #workspace{ padding:14px; }

    .flashcard {
      position:relative;
      min-height:300px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 420px at 50% -30%, rgba(122,162,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:0 18px 48px rgba(0,0,0,.42);
      padding:18px 18px 16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      user-select:none;
      cursor:pointer;
    }

    .badge {
      position:absolute; top: 12px; left: 12px;
      font-size: 12px; color: var(--muted);
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 6px 10px; border-radius: 999px;
      z-index: 2;
      max-width: calc(50% - 18px);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .badge.right{ left:auto; right:12px; }

    .hidden{ display:none !important; }

    .content{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:26px 6px 10px;
      text-align:center;
      flex:1;
    }

    .big{
      font-size:44px;
      font-weight:800;
      letter-spacing:.6px;
      line-height:1.08;
    }
    .mid_jp{
      font-size:22px;
      font-weight:750;
      letter-spacing:.2px;
      line-height:1.1;
      color:var(--text);
    }
    .mid_txt{
      font-size:18px;
      color:var(--muted);
      font-weight:650;
    }
    .smallLine{
      font-size:14px;
      color:var(--muted2);
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .controls .row{justify-content:center}
    .stats{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }
    .toast {
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      min-height: 16px;
      padding: 8px 10px;
      border: 1px solid color-mix(in srgb, var(--border), #000 20%);
      border-radius: 12px;
      background: rgba(0,0,0,.18);
    }

    /* Mobile study mode (already present in CSS, activated by body.studying from JS) */
    @media (max-width: 720px) {
      main{ grid-template-columns: 1fr; }
      body.studying #sidebar { display: none; }
      body.studying #workspace { margin-top: 0; }
      body.studying .flashcard { margin-bottom: 34px; } /* extra cushion under card */
      body.studying #workspace { padding-bottom: 26px; }
      body.studying .settingsToggle { display: inline-flex; }
      body.studying.showSettings #sidebar {
        display: block;
        position: fixed;
        inset: 0;
        z-index: 1000;
        overflow: auto;
        padding-bottom: 24px;
      }
      body.studying.showSettings #workspace { filter: blur(2px); }
      body.studying.showSettings .closeSettings { display: inline-flex; }
    }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Japanese Flash Cards</h1>
      <div class="sub">
        <span class="ver">v1.5.7 · Build 24</span>
      </div>
    </div>

    <div class="badgeTop" title="Local, single-file app">
      <span class="dot"></span>
      <span class="mono">offline-ready</span>
    </div>
  </header>

  <main>
    <section class="panel" id="sidebar">
      <h2>
        Study Sets
        <button id="btn_closeSettings" class="ghost closeSettings hidden" type="button">Close</button>
      </h2>

      <div class="bd">
        <div class="row">
          <div class="pill">
            <input id="sel_all" type="checkbox" />
            <label for="sel_all"><b>Select All</b></label>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="pill">
            <input id="sel_essentials" type="checkbox" checked />
            <label for="sel_essentials">Essentials</label>
          </div>
          <div class="pill">
            <input id="sel_core" type="checkbox" checked />
            <label for="sel_core">Core Travel Vocabulary</label>
          </div>
          <div class="pill">
            <input id="sel_basic" type="checkbox" />
            <label for="sel_basic">Basic Japanese Words</label>
          </div>
          <div class="pill">
            <input id="sel_hira" type="checkbox" />
            <label for="sel_hira">Hiragana</label>
          </div>
          <div class="pill">
            <input id="sel_kata" type="checkbox" />
            <label for="sel_kata">Katakana</label>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <div style="flex:1; min-width:220px;">
            <div class="small" style="margin:0 0 6px 2px;">Build by Category (optional override)</div>
            <select id="by_category">
              <option value="">(No override)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btn_build" class="primary" type="button">Build Deck</button>
          <button id="btn_reset" class="ghost" type="button">Reset</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="muted">
            Select one or more sets, then click <b>Build Deck</b>.
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="pill">
            <input id="opt_shuffle" type="checkbox" checked />
            <label for="opt_shuffle">Shuffle</label>
          </div>
          <div class="pill">
            <input id="opt_randomSide" type="checkbox" checked />
            <label for="opt_randomSide">Random side</label>
          </div>
          <div class="pill">
            <input id="opt_incorrectOnly" type="checkbox" />
            <label for="opt_incorrectOnly">Incorrect-only view</label>
          </div>
          <div class="pill">
            <input id="opt_limit" type="number" min="0" value="0" style="width:80px" />
            <label for="opt_limit">Limit (0 = no limit)</label>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="workspace">
      <h2>
        Study
        <span class="small mono">v1.5.7 · Build 24</span>
      </h2>

      <div class="bd">
        <div class="flashcard" id="card" tabindex="0" title="Click to flip">
          <div class="badge" id="badge_left">—</div>
          <div class="badge right" id="badge_right">—</div>

          <div class="content">
            <div class="big" id="big">Build a deck to start</div>
            <div class="mid_jp hidden" id="mid_jp"></div>
            <div class="mid_txt" id="mid_txt"></div>
            <div class="smallLine" id="small"></div>
          </div>
        </div>

        <div class="controls">
          <div class="row">
            <button id="btn_prev">← Prev</button>
            <button id="btn_hint" class="ghost" type="button">Hint</button>
            <button class="primary" id="btn_flip">Flip</button>
            <button id="btn_next">Next →</button>
          </div>

          <div class="row">
            <button class="good" id="btn_correct">Correct</button>
            <button class="warn" id="btn_unsure">Unsure</button>
            <button class="bad" id="btn_incorrect">Incorrect</button>
          </div>

          <div class="row">
            <button id="btn_speak" class="ghost" type="button">Audio (Back)</button>
            <button id="btn_speakFront" class="ghost hidden" type="button">Audio (Front)</button>
          </div>

          <div class="stats" id="stats">Deck not built yet.</div>
          <button id="btn_settings" class="ghost settingsToggle hidden" type="button">Settings</button>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </section>
  </main>

<script>
/* ========= Japanese Flash Cards — v1.5.7 (Build 24) ========= */

const APP = { version: "1.5.7", build: 24 };

const SETS = {
  ESSENTIALS: "Essentials",
  CORE: "Core Travel Vocabulary",
  BASIC: "Basic Japanese Words",
  HIRAGANA: "Hiragana",
  KATAKANA: "Katakana"
};

function el(id){ return document.getElementById(id); }
function slug(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }

const selAll = el("sel_all");
const selEssentials = el("sel_essentials");
const selCore = el("sel_core");
const selBasic = el("sel_basic");
const selHira = el("sel_hira");
const selKata = el("sel_kata");

const optRandomSide = el("opt_randomSide");
const optShuffle = el("opt_shuffle");
const optLimit = el("opt_limit");
const optIncorrectOnly = el("opt_incorrectOnly");

const btnBuild = el("btn_build");
const btnReset = el("btn_reset");
const btnPrev = el("btn_prev");
const btnNext = el("btn_next");
const btnHint = el("btn_hint");
const btnFlip = el("btn_flip");
const btnCorrect = el("btn_correct");
const btnUnsure = el("btn_unsure");
const btnIncorrect = el("btn_incorrect");
const btnSpeak = el("btn_speak");
const btnSpeakFront = el("btn_speakFront");

const btnSettings = el("btn_settings");
const btnCloseSettings = el("btn_closeSettings");

const byCategoryEl = el("by_category");

const cardEl = el("card");
const bigEl = el("big");
const midJpEl = el("mid_jp");
const midTxtEl = el("mid_txt");
const smallEl = el("small");
const badgeLeft = el("badge_left");
const badgeRight = el("badge_right");
const statsEl = el("stats");
const toastEl = el("toast");

let deckAll = [];
let deckView = [];
let idx = 0;
let showingFront = true;
let showHintOnFront = false;

let incorrectIds = new Set(); // for incorrect-only view
let mobileSettingsOpen = false;

function showToast(msg){
  toastEl.textContent = msg;
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function syncSelectAllCheckbox() {
  const allChecked = selEssentials.checked && selCore.checked && selBasic.checked && selHira.checked && selKata.checked;
  const noneChecked = !selEssentials.checked && !selCore.checked && !selBasic.checked && !selHira.checked && !selKata.checked;
  selAll.indeterminate = !allChecked && !noneChecked;
  selAll.checked = allChecked;
}

function selectedSets() {
  const sets = [];
  if (selEssentials.checked) sets.push(SETS.ESSENTIALS);
  if (selCore.checked) sets.push(SETS.CORE);
  if (selBasic.checked) sets.push(SETS.BASIC);
  if (selHira.checked) sets.push(SETS.HIRAGANA);
  if (selKata.checked) sets.push(SETS.KATAKANA);
  return sets;
}

function buildCardsFromVocab(setName) {
  const out = [];
  const categories = VOCAB[setName] || {};
  for (const [cat, items] of Object.entries(categories)) {
    for (const item of items) {
      const id = `${slug(setName)}:${slug(cat)}:${slug(item.english)}:${slug(item.japanese)}`;
      out.push({
        id,
        set: setName,
        category: cat,
        type: "vocab",
        english: item.english,
        japanese: item.japanese,
        romaji: item.romaji,
        pronunciation: item.pronunciation
      });
    }
  }
  return out;
}

function buildKanaCards(setName, arr) {
  return arr.map(k => ({
    id: `${slug(setName)}:kana:${slug(k.jp)}:${slug(k.romaji)}`,
    set: setName,
    category: "Kana",
    type: "kana",
    english: k.romaji.toUpperCase(),
    japanese: k.jp,
    romaji: k.romaji,
    pronunciation: k.pron
  }));
}

function buildDeckByCategory(category) {
  let cards = [];
  for (const setName of Object.keys(VOCAB)) {
    const cats = VOCAB[setName] || {};
    if (cats[category]) {
      for (const item of cats[category]) {
        const id = `${slug(setName)}:${slug(category)}:${slug(item.english)}:${slug(item.japanese)}`;
        cards.push({ id, set: setName, category, type:"vocab", ...item });
      }
    }
  }
  return cards;
}

function rebuildDeck() {
  const overrideCategory = byCategoryEl.value;
  let cards = [];
  showHintOnFront = false;

  if (overrideCategory) {
    cards = buildDeckByCategory(overrideCategory);
  } else {
    const sets = selectedSets();
    for (const s of sets) {
      if (s === SETS.HIRAGANA) cards.push(...buildKanaCards(SETS.HIRAGANA, HIRAGANA));
      else if (s === SETS.KATAKANA) cards.push(...buildKanaCards(SETS.KATAKANA, KATAKANA));
      else cards.push(...buildCardsFromVocab(s));
    }
  }

  // de-dupe
  const seen = new Set();
  cards = cards.filter(c => {
    const k = `${c.set}|${c.category}|${c.english}|${c.japanese}`;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });

  // optional limit
  const lim = Math.max(0, parseInt(optLimit.value || "0", 10));
  if (lim > 0) cards = cards.slice(0, lim);

  if (optShuffle.checked) shuffle(cards);

  deckAll = cards;
  idx = 0;
  showingFront = optRandomSide.checked ? (Math.random() < 0.5) : true;

  rebuildView();
  showToast(`Built deck: ${deckAll.length} cards`);
  render();
}

function rebuildView() {
  if (!optIncorrectOnly.checked) {
    deckView = [...deckAll];
  } else {
    deckView = deckAll.filter(c => incorrectIds.has(c.id));
  }
  idx = Math.min(idx, Math.max(0, deckView.length - 1));
}

function currentCard(){
  return deckView[idx] || null;
}

function isMobileViewport(){
  return window.matchMedia("(max-width: 720px)").matches;
}

function updateSettingsButtons() {
  const show = document.body.classList.contains("studying") && isMobileViewport();
  if (btnSettings) btnSettings.classList.toggle("hidden", !show);
  if (btnCloseSettings) btnCloseSettings.classList.toggle("hidden", !(show && mobileSettingsOpen));
}

function toggleSettingsOverlay(open) {
  mobileSettingsOpen = (open !== undefined) ? !!open : !mobileSettingsOpen;
  document.body.classList.toggle("showSettings", mobileSettingsOpen);
  updateSettingsButtons();
}

function nextCard() {
  showHintOnFront = false;
  if (idx < deckView.length - 1) idx++;
  showingFront = optRandomSide.checked ? (Math.random() < 0.5) : true;
  render();
}

function prevCard() {
  showHintOnFront = false;
  if (idx > 0) idx--;
  showingFront = optRandomSide.checked ? (Math.random() < 0.5) : true;
  render();
}

function flipCard() {
  showingFront = !showingFront;
  render();
}

function markCorrect(){
  showToast("Correct");
  nextCard();
}

function markIncorrect(){
  const card = currentCard();
  if (card) incorrectIds.add(card.id);
  showToast("Incorrect");
  nextCard();
}

function markUnsure(){
  // Unsure = Incorrect (your rule)
  const card = currentCard();
  if (card) incorrectIds.add(card.id);
  showToast("Unsure → Incorrect");
  nextCard();
}

function speak(text, lang="ja-JP"){
  try{
    if (!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  } catch {
    showToast("Unable to play speech in this browser.");
  }
}

function render() {
  if (!deckView || deckView.length === 0) {
    badgeLeft.textContent = "—";
    badgeRight.textContent = optIncorrectOnly.checked ? "Incorrect Only" : "—";
    badgeLeft.classList.remove("hidden");
    badgeRight.classList.remove("hidden");
    if (btnHint) btnHint.classList.add("hidden");

    bigEl.textContent = deckAll.length ? "No cards in this view" : "Build a deck to start";
    midJpEl.classList.add("hidden");
    midJpEl.textContent = "";
    midTxtEl.classList.remove("hidden");
    midTxtEl.textContent = deckAll.length
      ? "You have no incorrect cards yet (or you cleared them)."
      : "Select sets on the left, then click Build Deck.";
    smallEl.textContent = "";
    statsEl.textContent = deckAll.length ? `Deck: ${deckAll.length} cards` : "Deck not built yet.";

    const isMobileLayout = window.matchMedia("(max-width: 720px)").matches;
    const isStudyingDeck = deckAll.length > 0;
    document.body.classList.toggle("studying", isMobileLayout && isStudyingDeck);
    updateSettingsButtons();

    return;
  }

  const card = currentCard();
  const showFrontFace = showingFront;
  const showEnglishFace = !showFrontFace;

  // card content
  const frontMain = card.japanese || "";
  const backMain = card.english || "";
  const frontSub = card.romaji ? `(${card.romaji})` : "";
  const backSub = card.japanese ? `(${card.japanese})` : "";

  badgeLeft.textContent = `${card.set}`;
  badgeRight.textContent = `${card.category}${optIncorrectOnly.checked ? " · Incorrect Only" : ""}`;

  // Hide Study Set / Category on the FRONT by default (so it doesn't give away the answer).
  // Use Hint to reveal on front; always show on back.
  const hideMeta = showingFront && !showHintOnFront && card.set !== "Intro";
  badgeLeft.classList.toggle("hidden", hideMeta);
  badgeRight.classList.toggle("hidden", hideMeta);
  if (btnHint) btnHint.classList.toggle("hidden", !showingFront || card.set === "Intro");

  bigEl.textContent = showFrontFace ? frontMain : backMain;

  const subText = showFrontFace ? frontSub : backSub;
  if (subText) {
    midTxtEl.classList.remove("hidden");
    midTxtEl.textContent = subText;
  } else {
    midTxtEl.classList.add("hidden");
    midTxtEl.textContent = "";
  }

  // Show pronunciation line if present
  const p = (card.pronunciation || "").trim();
  smallEl.textContent = p ? `Pron: ${p}` : "";

  // Audio buttons
  const showBackSpeak = !!(showEnglishFace ? card.japanese : card.english);
  const showFrontSpeak = !!(showFrontFace ? card.japanese : card.english);

  btnSpeak.disabled = !showBackSpeak;
  btnSpeak.style.opacity = showBackSpeak ? "1" : "0.55";

  btnSpeakFront.classList.toggle("hidden", !showFrontSpeak);
  btnSpeakFront.disabled = !showFrontSpeak;
  btnSpeakFront.style.opacity = showFrontSpeak ? "1" : "0.55";

  // Mobile web study mode: once a deck exists, hide/compress the sidebar and top chrome for more space.
  // CSS handles the layout under @media (max-width: 720px).
  const isMobileLayout = window.matchMedia("(max-width: 720px)").matches;
  const isStudyingDeck = deckAll.length > 0; // built at least once
  document.body.classList.toggle("studying", isMobileLayout && isStudyingDeck);
  updateSettingsButtons();

  statsEl.textContent = `Card ${idx + 1} / ${deckView.length} · Deck: ${deckAll.length} cards`;
}

btnBuild.addEventListener("click", rebuildDeck);
btnReset.addEventListener("click", () => {
  deckAll = [];
  deckView = [];
  idx = 0;
  showingFront = true;
  showHintOnFront = false;
  incorrectIds = new Set();
  byCategoryEl.value = "";
  optIncorrectOnly.checked = false;
  document.body.classList.remove("studying","showSettings");
  mobileSettingsOpen = false;
  showToast("Reset");
  render();
});

btnPrev.addEventListener("click", prevCard);
btnNext.addEventListener("click", nextCard);
btnFlip.addEventListener("click", flipCard);

btnCorrect.addEventListener("click", markCorrect);
btnUnsure.addEventListener("click", markUnsure);
btnIncorrect.addEventListener("click", markIncorrect);

btnHint.addEventListener("click", () => { showHintOnFront = !showHintOnFront; render(); });

btnSpeak.addEventListener("click", () => {
  const c = currentCard();
  if (!c) return;
  const text = showingFront ? (c.english || "") : (c.japanese || "");
  speak(text, "ja-JP");
});

btnSpeakFront.addEventListener("click", () => {
  const c = currentCard();
  if (!c) return;
  const text = showingFront ? (c.japanese || "") : (c.english || "");
  speak(text, "ja-JP");
});

cardEl.addEventListener("click", flipCard);
cardEl.addEventListener("keydown", (e) => {
  if (e.key === " " || e.key === "Enter") { e.preventDefault(); flipCard(); }
  if (e.key === "ArrowLeft") prevCard();
  if (e.key === "ArrowRight") nextCard();
});

selAll.addEventListener("change", () => {
  const v = selAll.checked;
  selEssentials.checked = v;
  selCore.checked = v;
  selBasic.checked = v;
  selHira.checked = v;
  selKata.checked = v;
  syncSelectAllCheckbox();
  populateByCategory();
  showToast("Selection updated");
});
[selEssentials, selCore, selBasic, selHira, selKata].forEach(cb => cb.addEventListener("change", () => {
  syncSelectAllCheckbox();
  populateByCategory();
}));

optIncorrectOnly.addEventListener("change", () => {
  rebuildView();
  render();
});

if (btnSettings) btnSettings.addEventListener("click", () => toggleSettingsOverlay(true));
if (btnCloseSettings) btnCloseSettings.addEventListener("click", () => toggleSettingsOverlay(false));
window.addEventListener("resize", () => { updateSettingsButtons(); render(); });

function populateByCategory() {
  // Collect categories from selected sets across VOCAB
  const cats = new Set();
  const sets = selectedSets();

  for (const s of sets) {
    if (s === SETS.HIRAGANA || s === SETS.KATAKANA) continue;
    const obj = VOCAB[s] || {};
    Object.keys(obj).forEach(k => cats.add(k));
  }

  const cur = byCategoryEl.value;
  byCategoryEl.innerHTML = '<option value="">(No override)</option>';
  [...cats].sort().forEach(c => {
    const o = document.createElement("option");
    o.value = c; o.textContent = c;
    byCategoryEl.appendChild(o);
  });
  if ([...byCategoryEl.options].some(o => o.value === cur)) byCategoryEl.value = cur;
}

const VOCAB = {
  [SETS.ESSENTIALS]: {
    "Essentials": [
      { english: "Excuse me / Sorry", japanese: "すみません", romaji: "Sumimasen", pronunciation: "soo-mee-mah-sen" },
      { english: "Thank you very much", japanese: "ありがとうございます", romaji: "Arigatō gozaimasu", pronunciation: "ah-ree-gah-toh goh-zah-ee-mas" },
      { english: "This", japanese: "これ", romaji: "Kore", pronunciation: "koh-reh" },
      { english: "That", japanese: "それ", romaji: "Sore", pronunciation: "soh-reh" },
      { english: "That (over there)", japanese: "あれ", romaji: "Are", pronunciation: "ah-reh" },
      { english: "Here", japanese: "ここ", romaji: "Koko", pronunciation: "koh-koh" },
      { english: "There", japanese: "そこ", romaji: "Soko", pronunciation: "soh-koh" },
      { english: "Over there", japanese: "あそこ", romaji: "Asoko", pronunciation: "ah-soh-koh" }
    ]
  },

  [SETS.CORE]: {
    "Questions": [
      { english: "What is this?", japanese: "これは何ですか", romaji: "Kore wa nan desu ka", pronunciation: "koh-reh wah nahn dess kah" },
      { english: "How much?", japanese: "いくらですか", romaji: "Ikura desu ka", pronunciation: "ee-koo-rah dess kah" },
      { english: "Where is the bathroom?", japanese: "トイレはどこですか", romaji: "Toire wa doko desu ka", pronunciation: "toy-reh wah doh-koh dess kah" },
      { english: "Where is the station?", japanese: "駅はどこですか", romaji: "Eki wa doko desu ka", pronunciation: "eh-kee wah doh-koh dess kah" }
    ],
    "Time": [
      { english: "Morning / a.m.", japanese: "ごぜん", romaji: "Gozen", pronunciation: "goh-zen" },
      { english: "Afternoon / p.m.", japanese: "ごご", romaji: "Gogo", pronunciation: "goh-goh" }
    ]
  },

  [SETS.BASIC]: {
    "Key Phrases and Vocabulary": [
      { english: "Yes", japanese: "はい", romaji: "Hai", pronunciation: "hai" },
      { english: "No", japanese: "いいえ", romaji: "Iie", pronunciation: "ee-eh" },
      { english: "What is your name?", japanese: "名前はなんですか", romaji: "Namae wa nan desu ka", pronunciation: "nah-mah-eh wah nahn dess kah" },
      { english: "I am ~", japanese: "私は〜です", romaji: "Watashi wa ~ desu", pronunciation: "wah-tah-shee wah ... dess" },
      { english: "I came from ~ / I am from ~", japanese: "〜から来ました", romaji: "~ kara kimashita", pronunciation: "... kah-rah kee-mah-shee-tah" },
      { english: "What is this?", japanese: "これは何ですか", romaji: "Kore wa nan desu ka", pronunciation: "koh-reh wah nahn dess kah" },
      { english: "How much?", japanese: "いくらですか", romaji: "Ikura desu ka", pronunciation: "ee-koo-rah dess kah" },
      { english: "Can I get this one? / I will take this one", japanese: "これください", romaji: "Kore kudasai", pronunciation: "koh-reh koo-dah-sigh" },
      { english: "Please", japanese: "おねがいします", romaji: "Onegaishimasu", pronunciation: "oh-neh-guy-shee-mas" },
      { english: "Can I place an order?", japanese: "注文お願いします", romaji: "Chūmon onegaishimasu", pronunciation: "choo-mohn oh-neh-guy-shee-mas" },
      { english: "Water please", japanese: "水をお願いします", romaji: "Mizu o onegaishimasu", pronunciation: "mee-zoo oh oh-neh-guy-shee-mas" },
      { english: "Can I get the check / bill please", japanese: "お会計お願いします", romaji: "Okaikei onegaishimasu", pronunciation: "oh-kai-kay oh-neh-guy-shee-mas" },
      { english: "Where am I?", japanese: "ここはどこですか", romaji: "Koko wa doko desu ka", pronunciation: "koh-koh wah doh-koh dess kah" },
      { english: "Where is the bathroom?", japanese: "トイレはどこですか", romaji: "Toire wa doko desu ka", pronunciation: "toy-reh wah doh-koh dess kah" },
      { english: "Where is the train station?", japanese: "駅はどこですか", romaji: "Eki wa doko desu ka", pronunciation: "eh-kee wah doh-koh dess kah" },
      { english: "What time is it now?", japanese: "今何時ですか", romaji: "Ima nan ji desu ka", pronunciation: "ee-mah nahn jee dess kah" },
      { english: "I don’t understand", japanese: "わかりません", romaji: "Wakarimasen", pronunciation: "wah-kah-ree-mah-sen" },
      { english: "I can’t speak Japanese", japanese: "日本語を話せません", romaji: "Nihongo o hanasemasen", pronunciation: "nee-hohn-goh oh hah-nah-seh-mah-sen" }
    ],

    "Greetings": [
      { english: "Good morning", japanese: "おはようございます", romaji: "Ohayō gozaimasu", pronunciation: "oh-hah-yoh goh-zah-ee-mas" },
      { english: "Good afternoon", japanese: "こんにちは", romaji: "Konnichiwa", pronunciation: "kon-nee-chee-wah" },
      { english: "Good evening", japanese: "こんばんは", romaji: "Konbanwa", pronunciation: "kon-bahn-wah" },
      { english: "Thank you", japanese: "ありがとうございます", romaji: "Arigatō gozaimasu", pronunciation: "ah-ree-gah-toh goh-zah-ee-mas" },
      { english: "Excuse me / I am sorry", japanese: "すみません", romaji: "Sumimasen", pronunciation: "soo-mee-mah-sen" }
    ],

    "People / Pronouns": [
      { english: "I (watashi / boku / ore)", japanese: "私、僕、俺", romaji: "Watashi / Boku / Ore", pronunciation: "" },
      { english: "Friend", japanese: "友達", romaji: "Tomodachi", pronunciation: "toh-moh-dah-chee" },
      { english: "Co-worker", japanese: "同僚", romaji: "Dōryō", pronunciation: "doh-ryoh" },
      { english: "Boss / Company president", japanese: "部長、社長", romaji: "Buchō / Shachō", pronunciation: "" },
      { english: "Family", japanese: "家族", romaji: "Kazoku", pronunciation: "kah-zoh-koo" },
      { english: "Father", japanese: "お父さん", romaji: "Otō-san", pronunciation: "oh-toh-sahn" },
      { english: "Mother", japanese: "お母さん", romaji: "Okā-san", pronunciation: "oh-kah-sahn" },
      { english: "Older brother", japanese: "お兄さん", romaji: "Onii-san", pronunciation: "oh-nee-sahn" },
      { english: "Older sister", japanese: "お姉さん", romaji: "Onee-san", pronunciation: "oh-neh-sahn" },
      { english: "Younger brother", japanese: "弟", romaji: "Otōto", pronunciation: "oh-toh-toh" },
      { english: "Younger sister", japanese: "妹", romaji: "Imōto", pronunciation: "ee-moh-toh" },
      { english: "Adults", japanese: "大人", romaji: "Otona", pronunciation: "oh-toh-nah" },
      { english: "Children", japanese: "子供", romaji: "Kodomo", pronunciation: "koh-doh-moh" },
      { english: "Boyfriend", japanese: "彼氏", romaji: "Kareshi", pronunciation: "kah-reh-shee" },
      { english: "Girlfriend", japanese: "彼女", romaji: "Kanojo", pronunciation: "kah-noh-joh" },
      { english: "Man", japanese: "男の人", romaji: "Otoko-no-hito", pronunciation: "" },
      { english: "Woman", japanese: "女の人", romaji: "Onna-no-hito", pronunciation: "" }
    ],

    "Food and drink": [
      { english: "Breakfast", japanese: "朝ご飯", romaji: "Asa-gohan", pronunciation: "" },
      { english: "Lunch", japanese: "昼ご飯", romaji: "Hiru-gohan", pronunciation: "" },
      { english: "Dinner", japanese: "夜ご飯", romaji: "Yoru-gohan", pronunciation: "" },
      { english: "Rice / meal", japanese: "ご飯", romaji: "Gohan", pronunciation: "goh-hahn" },
      { english: "Bread", japanese: "パン", romaji: "Pan", pronunciation: "pahn" },
      { english: "Meat", japanese: "肉", romaji: "Niku", pronunciation: "nee-koo" },
      { english: "Fish", japanese: "魚", romaji: "Sakana", pronunciation: "sah-kah-nah" },
      { english: "Vegetables", japanese: "野菜", romaji: "Yasai", pronunciation: "yah-sigh" },
      { english: "Fruits", japanese: "果物", romaji: "Kudamono", pronunciation: "koo-dah-moh-noh" },
      { english: "Soup", japanese: "スープ", romaji: "Sūpu", pronunciation: "soo-poo" },
      { english: "Salad", japanese: "サラダ", romaji: "Sarada", pronunciation: "sah-rah-dah" },
      { english: "Egg", japanese: "卵", romaji: "Tamago", pronunciation: "tah-mah-goh" },
      { english: "Milk", japanese: "牛乳", romaji: "Gyūnyū", pronunciation: "gyoo-nyoo" },
      { english: "Cheese", japanese: "チーズ", romaji: "Chīzu", pronunciation: "chee-zoo" },
      { english: "Dessert", japanese: "デザート", romaji: "Dezāto", pronunciation: "deh-zah-toh" },
      { english: "Water", japanese: "水", romaji: "Mizu", pronunciation: "mee-zoo" },
      { english: "Tea / green tea", japanese: "お茶", romaji: "Ocha", pronunciation: "oh-chah" },
      { english: "Coffee", japanese: "コーヒー", romaji: "Kōhī", pronunciation: "koh-hee" },
      { english: "Alcohol / sake", japanese: "お酒", romaji: "Osake", pronunciation: "oh-sah-keh" },
      { english: "Wine", japanese: "ワイン", romaji: "Wain", pronunciation: "wine" },
      { english: "Beer", japanese: "ビール", romaji: "Bīru", pronunciation: "bee-roo" }
    ],

    "Numbers": [
      { english: "1", japanese: "一", romaji: "Ichi", pronunciation: "ee-chee" },
      { english: "2", japanese: "二", romaji: "Ni", pronunciation: "nee" },
      { english: "3", japanese: "三", romaji: "San", pronunciation: "sahn" },
      { english: "4", japanese: "四", romaji: "Yon", pronunciation: "yohn" },
      { english: "5", japanese: "五", romaji: "Go", pronunciation: "goh" },
      { english: "6", japanese: "六", romaji: "Roku", pronunciation: "roh-koo" },
      { english: "7", japanese: "七", romaji: "Nana", pronunciation: "nah-nah" },
      { english: "8", japanese: "八", romaji: "Hachi", pronunciation: "hah-chee" },
      { english: "9", japanese: "九", romaji: "Kyū", pronunciation: "kyoo" },
      { english: "10", japanese: "十", romaji: "Jū", pronunciation: "joo" },
      { english: "11", japanese: "十一", romaji: "Jūichi", pronunciation: "joo-ee-chee" },
      { english: "12", japanese: "十二", romaji: "Jūni", pronunciation: "joo-nee" },
      { english: "20", japanese: "二十", romaji: "Nijū", pronunciation: "nee-joo" },
      { english: "21", japanese: "二十一", romaji: "Nijūichi", pronunciation: "nee-joo-ee-chee" },
      { english: "30", japanese: "三十", romaji: "Sanjū", pronunciation: "sahn-joo" },
      { english: "32", japanese: "三十二", romaji: "Sanjūni", pronunciation: "sahn-joo-nee" },
      { english: "40", japanese: "四十", romaji: "Yonjū", pronunciation: "yohn-joo" },
      { english: "43", japanese: "四十三", romaji: "Yonjūsan", pronunciation: "yohn-joo-sahn" },
      { english: "50", japanese: "五十", romaji: "Gojū", pronunciation: "goh-joo" },
      { english: "54", japanese: "五十四", romaji: "Gojūyon", pronunciation: "goh-joo-yohn" },
      { english: "60", japanese: "六十", romaji: "Rokujū", pronunciation: "roh-koo-joo" },
      { english: "65", japanese: "六十五", romaji: "Rokujūgo", pronunciation: "roh-koo-joo-goh" },
      { english: "70", japanese: "七十", romaji: "Nanajū", pronunciation: "nah-nah-joo" },
      { english: "76", japanese: "七十六", romaji: "Nanajūroku", pronunciation: "nah-nah-joo-roh-koo" },
      { english: "80", japanese: "八十", romaji: "Hachijū", pronunciation: "hah-chee-joo" },
      { english: "87", japanese: "八十七", romaji: "Hachijūnana", pronunciation: "hah-chee-joo-nah-nah" },
      { english: "90", japanese: "九十", romaji: "Kyūjū", pronunciation: "kyoo-joo" },
      { english: "98", japanese: "九十八", romaji: "Kyūjūhachi", pronunciation: "kyoo-joo-hah-chee" },
      { english: "100", japanese: "百", romaji: "Hyaku", pronunciation: "hyah-koo" },
      { english: "1000", japanese: "千", romaji: "Sen", pronunciation: "sen" },
      { english: "2000", japanese: "二千", romaji: "Nisen", pronunciation: "nee-sen" },
      { english: "3000", japanese: "三千", romaji: "Sanzen", pronunciation: "sahn-zen" },
      { english: "5000", japanese: "五千", romaji: "Gosen", pronunciation: "goh-sen" }
    ]
  }
};

const HIRAGANA = [
  { jp:"あ", romaji:"a", pron:"ah" }, { jp:"い", romaji:"i", pron:"ee" }, { jp:"う", romaji:"u", pron:"oo" }, { jp:"え", romaji:"e", pron:"eh" }, { jp:"お", romaji:"o", pron:"oh" }
];
const KATAKANA = [
  { jp:"ア", romaji:"a", pron:"ah" }, { jp:"イ", romaji:"i", pron:"ee" }, { jp:"ウ", romaji:"u", pron:"oo" }, { jp:"エ", romaji:"e", pron:"eh" }, { jp:"オ", romaji:"o", pron:"oh" }
];

// Init
syncSelectAllCheckbox();
populateByCategory();
render();
</script>
</body>
</html>
